# VERIFY.md

æœ¬æ–‡æ¡£è®°å½•çº³ä»€å‡è¡¡éªŒè¯å™¨ï¼ˆNash Equilibrium Verifierï¼‰çš„è®¾è®¡æ–¹æ¡ˆå’Œå®ç°ç»†èŠ‚ã€‚

## æ–‡æ¡£ç›®æ ‡

- é˜è¿°ä¸ºä»€ä¹ˆéœ€è¦çº³ä»€å‡è¡¡éªŒè¯
- è¯´æ˜éªŒè¯çš„ç†è®ºåŸºç¡€å’Œæ ¸å¿ƒé€»è¾‘
- è®¾è®¡ç®€åŒ–ä½†æœ‰æ•ˆçš„éªŒè¯æ–¹æ¡ˆ
- åˆ†æè®¡ç®—æˆæœ¬å’Œä¼˜åŒ–ç­–ç•¥
- ä¸ºMADDPGå’ŒBR-PSOçš„å¯¹æ¯”å®éªŒæä¾›éªŒè¯åŸºç¡€

---

## 1. ä¸ºä»€ä¹ˆéœ€è¦éªŒè¯ï¼Ÿ

### 1.1 æ ¸å¿ƒé—®é¢˜

**ç®—æ³•æ”¶æ•› â‰  æ‰¾åˆ°çº³ä»€å‡è¡¡**

```python
# å¸¸è§è¯¯åŒº
if convergence_detected:
    print("æ‰¾åˆ°çº³ä»€å‡è¡¡äº†ï¼")  # âŒ é”™è¯¯ï¼

# æ­£ç¡®ç†è§£
if convergence_detected:
    print("ç­–ç•¥ä¸å†å˜åŒ–äº†")  # âœ… åªæ˜¯åœæ­¢æ›´æ–°
    # ä½†éœ€è¦éªŒè¯ï¼šæ˜¯å¦æ»¡è¶³çº³ä»€å‡è¡¡å®šä¹‰ï¼Ÿ
```

### 1.2 å¯èƒ½çš„æƒ…å†µ

å½“ç®—æ³•æŠ¥å‘Š"æ”¶æ•›"æ—¶ï¼Œå¯èƒ½å‡ºç°ä»¥ä¸‹æƒ…å†µï¼š

1. âœ… **çœŸçš„æ‰¾åˆ°äº†çº³ä»€å‡è¡¡** - æ‰€æœ‰agentéƒ½æ— æ³•é€šè¿‡æ”¹å˜ç­–ç•¥è·å¾—æ›´å¥½æ”¶ç›Š
2. âŒ **é™·å…¥äº†å±€éƒ¨æœ€ä¼˜** - æ¢¯åº¦ä¸ºé›¶ä½†ä¸æ˜¯çº³ä»€å‡è¡¡
3. âŒ **æŒ¯è¡åæš‚æ—¶ç¨³å®š** - ä¼ªæ”¶æ•›ï¼Œç»§ç»­è®­ç»ƒå¯èƒ½è¿˜ä¼šå˜åŒ–
4. âŒ **ç®—æ³•å®ç°é—®é¢˜** - å¦‚å­¦ä¹ ç‡å¤ªå°å¯¼è‡´è¿‡æ—©åœæ­¢

### 1.3 éªŒè¯çš„å¿…è¦æ€§

- **MADDPG**ï¼šåŸºäºæ¢¯åº¦ä¼˜åŒ–ï¼Œå¯èƒ½é™·å…¥å±€éƒ¨æœ€ä¼˜
- **BR-PSO**ï¼šPSOçš„ç¾¤ä½“æ™ºèƒ½ä¸ä¿è¯å…¨å±€æœ€ä¼˜
- **å¯¹æ¯”å®éªŒ**ï¼šéœ€è¦å…¬å¹³åœ°è¯„ä»·ä¸¤ç§ç®—æ³•æ‰¾åˆ°çš„è§£çš„è´¨é‡
- **è®ºæ–‡å‘è¡¨**ï¼šå¿…é¡»æä¾›çº³ä»€å‡è¡¡è´¨é‡çš„å®šé‡è¯æ®

---

## 2. çº³ä»€å‡è¡¡çš„ç†è®ºåŸºç¡€

### 2.1 æ•°å­¦å®šä¹‰

ç­–ç•¥ç»„åˆ $\pi^* = (\pi_1^*, \pi_2^*, ..., \pi_N^*)$ æ˜¯**çº³ä»€å‡è¡¡**ï¼Œå½“ä¸”ä»…å½“ï¼š

$$
\forall i \in \{1,...,N\}, \forall \pi_i \in \Pi_i: \quad U_i(\pi_i^*, \pi_{-i}^*) \geq U_i(\pi_i, \pi_{-i}^*)
$$

**ç¬¦å·è¯´æ˜**ï¼š
- $\pi_i^*$ï¼šagent $i$ çš„å‡è¡¡ç­–ç•¥
- $\pi_{-i}^*$ï¼šå…¶ä»–æ‰€æœ‰agentçš„å‡è¡¡ç­–ç•¥
- $U_i(\cdot)$ï¼šagent $i$ çš„æ”¶ç›Šå‡½æ•°
- $\Pi_i$ï¼šagent $i$ çš„ç­–ç•¥ç©ºé—´

**é€šä¿—è§£é‡Š**ï¼š
> åœ¨çº³ä»€å‡è¡¡ç‚¹ï¼Œç»™å®šå…¶ä»–agentçš„ç­–ç•¥ä¸å˜ï¼Œä»»ä½•agentå•æ–¹é¢æ”¹å˜è‡ªå·±çš„ç­–ç•¥éƒ½æ— æ³•è·å¾—æ›´é«˜çš„æ”¶ç›Šã€‚

### 2.2 å®é™…é—®é¢˜

**æŒ‘æˆ˜1ï¼šè¿ç»­ç­–ç•¥ç©ºé—´**
- âŒ æ— æ³•æšä¸¾æ‰€æœ‰å¯èƒ½çš„ç­–ç•¥ $\pi_i$ï¼ˆ8ä¸ªæ—¶æ®µçš„è¿ç»­ä»·æ ¼ï¼Œæ— é™å¤šï¼‰
- âŒ æ— æ³•ç²¾ç¡®è®¡ç®—æ”¶ç›Š $U_i$ï¼ˆä¾èµ–UE-DTAä»¿çœŸï¼Œæœ‰éšæœºæ€§ï¼‰

**æŒ‘æˆ˜2ï¼šå¤šç»´ç­–ç•¥**
- æ¯ä¸ªagentéœ€è¦åˆ¶å®š8ä¸ªæ—¶æ®µçš„ä»·æ ¼ï¼š$\pi_i = [p_{i,0}, p_{i,1}, ..., p_{i,7}]$
- ç­–ç•¥ç©ºé—´ç»´åº¦ï¼š$\Pi_i = [p_{min}, p_{max}]^8$

### 2.3 å®ç”¨è§£å†³æ–¹æ¡ˆï¼šÎµ-çº³ä»€å‡è¡¡

$$
\forall i, \forall \pi_i: \quad U_i(\pi_i, \pi_{-i}^*) \leq U_i(\pi_i^*, \pi_{-i}^*) + \varepsilon
$$

**é€šä¿—è§£é‡Š**ï¼š
> å…è®¸æœ€å¤š $\varepsilon$ çš„æ”¶ç›Šæ”¹è¿›ï¼ˆå¦‚5%ï¼‰ã€‚å¦‚æœæ‰€æœ‰agentå•æ–¹é¢æ”¹å˜ç­–ç•¥åçš„æ”¶ç›Šæ”¹è¿›éƒ½å°äº5%ï¼Œåˆ™è®¤ä¸ºæ˜¯5%-çº³ä»€å‡è¡¡ã€‚

**è´¨é‡è¯„çº§æ ‡å‡†**ï¼š

| Îµ (Nash Gap) | è´¨é‡è¯„ä»· | è¯´æ˜ |
|--------------|---------|------|
| < 3% | ä¼˜ç§€ (Excellent) | éå¸¸æ¥è¿‘ç†è®ºçº³ä»€å‡è¡¡ |
| 3-5% | è‰¯å¥½ (Good) | å¯æ¥å—çš„è¿‘ä¼¼å‡è¡¡ |
| 5-10% | å¯æ¥å— (Acceptable) | æœ‰ä¸€å®šåç¦»ä½†å¯ç”¨ |
| > 10% | éœ€æ”¹è¿› (Poor) | åç¦»è¾ƒå¤§ï¼Œç®—æ³•éœ€æ”¹è¿› |

---

## 3. éªŒè¯çš„æ ¸å¿ƒé€»è¾‘

### 3.1 æ ¸å¿ƒæ€æƒ³ï¼ˆä¸€å¥è¯ï¼‰

> **å›ºå®šå…¶ä»–agentçš„ç­–ç•¥ï¼Œçœ‹å½“å‰agentèƒ½å¦é€šè¿‡æ”¹å˜è‡ªå·±çš„ç­–ç•¥è·å¾—æ›´é«˜æ”¶ç›Š**

### 3.2 éªŒè¯æµç¨‹ï¼ˆæç®€ç‰ˆï¼‰

```python
def verify_nash_equilibrium_core(env, equilibrium_prices, epsilon=0.05):
    """
    çº³ä»€å‡è¡¡éªŒè¯çš„æ ¸å¿ƒé€»è¾‘

    Args:
        equilibrium_prices: dict, {agent_id: np.array([p_0, ..., p_7])}
        epsilon: å¯æ¥å—çš„æœ€å¤§æ”¶ç›Šæ”¹è¿›æ¯”ä¾‹ï¼ˆé»˜è®¤5%ï¼‰

    Returns:
        bool, æ˜¯å¦ä¸ºÎµ-çº³ä»€å‡è¡¡
    """

    # è¯„ä¼°å½“å‰å‡è¡¡çš„æ”¶ç›Š
    current_rewards = env.step(equilibrium_prices)[1]

    # ğŸ”‘ å¯¹æ¯ä¸ªagentè¿›è¡ŒéªŒè¯ï¼ˆå¿…é¡»éªŒè¯æ‰€æœ‰agentï¼‰
    for agent_id in env.possible_agents:

        # æ­¥éª¤1ï¼šå›ºå®šå…¶ä»–agentçš„ç­–ç•¥
        fixed_other_prices = {
            aid: equilibrium_prices[aid]
            for aid in env.possible_agents if aid != agent_id
        }

        # æ­¥éª¤2ï¼šå°è¯•æ”¹å˜å½“å‰agentçš„ç­–ç•¥
        best_reward = current_rewards[agent_id]

        for _ in range(n_trials):  # å°è¯•n_trialsä¸ªä¸åŒçš„ç­–ç•¥
            # éšæœºç”Ÿæˆä¸€ä¸ªæ–°ç­–ç•¥ï¼ˆæˆ–å±€éƒ¨æ‰°åŠ¨ï¼‰
            new_prices = sample_deviation_strategy(agent_id)

            # æ„é€ å®Œæ•´ç­–ç•¥ï¼ˆå…¶ä»–agentä¸å˜ï¼‰
            test_prices = fixed_other_prices.copy()
            test_prices[agent_id] = new_prices

            # è¯„ä¼°æ–°ç­–ç•¥çš„æ”¶ç›Š
            test_reward = env.step(test_prices)[1][agent_id]

            if test_reward > best_reward:
                best_reward = test_reward

        # æ­¥éª¤3ï¼šè®¡ç®—æ”¶ç›Šæ”¹è¿›ç©ºé—´ï¼ˆNash Gapï¼‰
        nash_gap = (best_reward - current_rewards[agent_id]) / current_rewards[agent_id]

        # å¦‚æœæ”¹è¿›ç©ºé—´ > epsilonï¼Œè¯´æ˜æœ‰åˆ©å¯å›¾çš„åç¦»
        if nash_gap > epsilon:
            return False  # ä¸æ˜¯çº³ä»€å‡è¡¡

    return True  # æ‰€æœ‰agentéƒ½æ— æ³•æ˜¾è‘—æ”¹è¿›ï¼Œæ˜¯çº³ä»€å‡è¡¡
```

### 3.3 ç›´è§‚è§£é‡Š

å‡è®¾MADDPGæ‰¾åˆ°çš„å‡è¡¡ï¼š
```python
equilibrium = {
    'agent_0': [0.5, 0.6, 0.8, 0.9, 0.7, 0.6, 0.5, 0.4],  # æ”¶ç›Š: 3000
    'agent_1': [0.4, 0.5, 0.7, 0.8, 0.6, 0.5, 0.4, 0.3],  # æ”¶ç›Š: 2800
    'agent_2': [0.6, 0.7, 0.9, 1.0, 0.8, 0.7, 0.6, 0.5],  # æ”¶ç›Š: 3200
    'agent_3': [0.3, 0.4, 0.6, 0.7, 0.5, 0.4, 0.3, 0.2],  # æ”¶ç›Š: 2600
}

# éªŒè¯agent_0ï¼š
# - å›ºå®šagent_1ã€agent_2ã€agent_3çš„ä»·æ ¼ä¸å˜
# - å°è¯•ä¿®æ”¹agent_0çš„ä»·æ ¼ï¼ˆå¦‚æ”¹æˆ[0.6, 0.7, 0.9, 1.0, 0.8, 0.7, 0.6, 0.5]ï¼‰
# - å¦‚æœæ–°æ”¶ç›Š=3150 > 3000ï¼Œæ”¹è¿›5%
#   â†’ è¯´æ˜agent_0æœ‰åŠ¨æœºåç¦»å½“å‰ç­–ç•¥
#   â†’ ä¸æ˜¯çº³ä»€å‡è¡¡

# éªŒè¯agent_1ï¼š
# - å›ºå®šagent_0ã€agent_2ã€agent_3çš„ä»·æ ¼ä¸å˜
# - å°è¯•å„ç§agent_1çš„ä»·æ ¼
# - å¦‚æœæœ€ä½³æ–°æ”¶ç›Š=2840ï¼Œæ”¹è¿›ä»…1.4% < 5%
#   â†’ agent_1æ— æ˜¾è‘—æ”¹è¿›ç©ºé—´
#   â†’ å¯¹agent_1æ¥è¯´æ»¡è¶³çº³ä»€å‡è¡¡æ¡ä»¶
```

---

## 4. åç¦»ç­–ç•¥çš„æœç´¢æ–¹æ³•

### 4.1 ä¸ºä»€ä¹ˆéœ€è¦"éšæœºæ‰°åŠ¨"å’Œ"å¤šæ¬¡å°è¯•"ï¼Ÿ

**é—®é¢˜**ï¼šç­–ç•¥ç©ºé—´æ˜¯è¿ç»­ä¸”é«˜ç»´çš„ï¼ˆ8ä¸ªæ—¶æ®µçš„ä»·æ ¼ï¼‰ï¼Œæ— æ³•ç©·ä¸¾æ‰€æœ‰å¯èƒ½

**è§£å†³**ï¼šé€šè¿‡é‡‡æ ·æ–¹æ³•åœ¨ç­–ç•¥ç©ºé—´ä¸­æœç´¢

**ç±»æ¯”**ï¼š
```
åœ¨å±±ä¸Šæ‰¾æœ€é«˜ç‚¹ï¼š
current_position = å½“å‰å‡è¡¡ç­–ç•¥
current_height = å½“å‰æ”¶ç›Š

æ–¹æ³•1ï¼šéšæœºé‡‡æ · = éšæœºè·³åˆ°å±±çš„å„ä¸ªä½ç½®ï¼Œçœ‹æœ‰æ²¡æœ‰æ›´é«˜çš„
æ–¹æ³•2ï¼šå±€éƒ¨æ‰°åŠ¨ = åœ¨å½“å‰ä½ç½®é™„è¿‘çˆ¬ä¸€çˆ¬ï¼Œçœ‹èƒ½ä¸èƒ½ç»§ç»­å¾€ä¸Š
```

### 4.2 é‡‡ç”¨çš„æœç´¢ç­–ç•¥ï¼ˆç®€åŒ–ç‰ˆï¼‰

æˆ‘ä»¬é‡‡ç”¨**ä¸¤ç§æ–¹æ³•ç»„åˆ**ï¼š

#### æ–¹æ³•1ï¼šéšæœºé‡‡æ ·ï¼ˆå…¨å±€æ¢ç´¢ï¼‰

```python
def random_sample(agent_id, env):
    """åœ¨æ•´ä¸ªä»·æ ¼ç©ºé—´éšæœºé‡‡æ ·"""
    price_min, price_max = env.get_price_bounds(agent_id)
    n_periods = env.n_periods  # 8ä¸ªæ—¶æ®µ

    # ä¸ºæ‰€æœ‰8ä¸ªæ—¶æ®µéšæœºç”Ÿæˆä»·æ ¼
    new_prices = np.random.uniform(
        low=price_min,
        high=price_max,
        size=n_periods
    )

    return new_prices
```

**ä¼˜ç‚¹**ï¼š
- âœ… å…¨å±€æ¢ç´¢ï¼Œå¯èƒ½å‘ç°è¿œç¦»å½“å‰å‡è¡¡çš„æ›´å¥½ç­–ç•¥
- âœ… ä¸ä¾èµ–å½“å‰ç­–ç•¥çš„è´¨é‡

**ç¼ºç‚¹**ï¼š
- âŒ ç›²ç›®æœç´¢ï¼Œæ•ˆç‡è¾ƒä½
- âŒ å¯èƒ½é”™è¿‡å½“å‰ç­–ç•¥é™„è¿‘çš„å±€éƒ¨æœ€ä¼˜

#### æ–¹æ³•2ï¼šå±€éƒ¨æ‰°åŠ¨ï¼ˆå±€éƒ¨æ¢ç´¢ï¼‰

```python
def local_perturbation(current_prices, agent_id, env, sigma=0.05):
    """åœ¨å½“å‰ä»·æ ¼é™„è¿‘è¿›è¡Œæ‰°åŠ¨"""
    price_min, price_max = env.get_price_bounds(agent_id)
    price_range = price_max - price_min

    # ä¸º8ä¸ªæ—¶æ®µåˆ†åˆ«æ·»åŠ ç‹¬ç«‹çš„é«˜æ–¯æ‰°åŠ¨
    perturbation = np.random.normal(
        loc=0.0,
        scale=sigma * price_range,  # æ‰°åŠ¨å¹…åº¦ä¸ä»·æ ¼èŒƒå›´æˆæ­£æ¯”
        size=env.n_periods
    )

    new_prices = current_prices + perturbation

    # ç¡®ä¿åœ¨è¾¹ç•Œå†…
    new_prices = np.clip(new_prices, price_min, price_max)

    return new_prices
```

**æ‰°åŠ¨å¼ºåº¦åˆ†é…**ï¼š
- å°æ‰°åŠ¨ï¼ˆÏƒ=0.02ï¼‰ï¼šæ£€æŸ¥é™„è¿‘çš„å¾®è°ƒç­–ç•¥
- ä¸­æ‰°åŠ¨ï¼ˆÏƒ=0.05ï¼‰ï¼šå¹³è¡¡æ¢ç´¢èŒƒå›´å’Œç²¾åº¦
- å¤§æ‰°åŠ¨ï¼ˆÏƒ=0.10ï¼‰ï¼šæ›´å¤§èŒƒå›´çš„å±€éƒ¨æ¢ç´¢

**ä¼˜ç‚¹**ï¼š
- âœ… é«˜æ•ˆæ¢ç´¢å½“å‰ç­–ç•¥é™„è¿‘çš„ç©ºé—´
- âœ… å®¹æ˜“å‘ç°å±€éƒ¨æ”¹è¿›

**ç¼ºç‚¹**ï¼š
- âŒ å—é™äºå½“å‰ç­–ç•¥ï¼Œå¯èƒ½é”™è¿‡å…¨å±€æœ€ä¼˜

### 4.3 ç»„åˆç­–ç•¥

```python
# åˆ†é…è¯•éªŒæ¬¡æ•°ï¼ˆå‡è®¾æ€»å…±80æ¬¡ï¼‰
n_random = 40        # 50%ç”¨äºéšæœºé‡‡æ ·
n_perturbation = 40  # 50%ç”¨äºå±€éƒ¨æ‰°åŠ¨

# å±€éƒ¨æ‰°åŠ¨è¿›ä¸€æ­¥ç»†åˆ†ä¸ºä¸åŒå¼ºåº¦
perturbation_schedule = [
    (0.02, 13),  # å°æ‰°åŠ¨ï¼š13æ¬¡
    (0.05, 13),  # ä¸­æ‰°åŠ¨ï¼š13æ¬¡
    (0.10, 14),  # å¤§æ‰°åŠ¨ï¼š14æ¬¡
]
```

---

## 5. éªŒè¯æ‰€æœ‰Agentçš„å¿…è¦æ€§

### 5.1 å¿…é¡»éªŒè¯æ‰€æœ‰agent

**çº³ä»€å‡è¡¡çš„å®šä¹‰è¦æ±‚**ï¼š

$$
\text{çº³ä»€å‡è¡¡} \Leftrightarrow \forall i \in \{1,2,3,4\}: \text{agent}_i \text{æ— åˆ©å¯å›¾çš„å•è¾¹åç¦»}
$$

**å…³é”®**ï¼š
- âŒ ä¸èƒ½åªéªŒè¯éƒ¨åˆ†agent
- âœ… å¿…é¡»**æ‰€æœ‰**agentéƒ½æ— æ³•é€šè¿‡æ”¹å˜ç­–ç•¥è·å¾—æ˜¾è‘—æ”¶ç›Šæ”¹è¿›
- åªè¦æœ‰**ä¸€ä¸ª**agentèƒ½æ˜¾è‘—æ”¹è¿› â†’ å°±ä¸æ˜¯çº³ä»€å‡è¡¡

**ç¤ºä¾‹**ï¼š
```python
# å‡è®¾éªŒè¯ç»“æœ
nash_gaps = {
    'agent_0': 2.1%,  # âœ… å°äº5%
    'agent_1': 3.5%,  # âœ… å°äº5%
    'agent_2': 1.8%,  # âœ… å°äº5%
    'agent_3': 6.2%,  # âŒ å¤§äº5% â† åªè¦æœ‰ä¸€ä¸ªè¶…è¿‡ï¼Œå°±ä¸æ˜¯çº³ä»€å‡è¡¡
}

is_nash = max(nash_gaps.values()) < 0.05  # False

# ç»“è®ºï¼šè™½ç„¶3ä¸ªagentéƒ½æ»¡è¶³ï¼Œä½†agent_3ä¸æ»¡è¶³
# â†’ ä¸æ˜¯5%-çº³ä»€å‡è¡¡
```

### 5.2 è®¡ç®—é‡åˆ†æ

```python
# å•æ¬¡çº³ä»€å‡è¡¡éªŒè¯çš„è®¡ç®—æˆæœ¬

æ€»UE-DTAè°ƒç”¨æ¬¡æ•° = n_agents Ã— n_trials

# å…·ä½“æ•°å­—ï¼ˆæˆ‘ä»¬çš„åœºæ™¯ï¼‰
n_agents = 4              # 4ä¸ªå……ç”µç«™
n_trials = 80             # æ¯ä¸ªagentå°è¯•80æ¬¡åç¦»
t_ue_dta = 2ç§’            # å•æ¬¡UE-DTAä»¿çœŸæ—¶é—´

# ä¸²è¡Œæ‰§è¡Œ
æ€»è°ƒç”¨æ¬¡æ•° = 4 Ã— 80 = 320æ¬¡
æ€»æ—¶é—´ = 320 Ã— 2ç§’ = 640ç§’ â‰ˆ 10.7åˆ†é’Ÿ

# å¹¶è¡Œæ‰§è¡Œï¼ˆå¦‚æœå¯ä»¥å¹¶è¡ŒéªŒè¯4ä¸ªagentï¼‰
å¹¶è¡Œæ€»æ—¶é—´ = 80 Ã— 2ç§’ = 160ç§’ â‰ˆ 2.7åˆ†é’Ÿ  # ç†è®ºåŠ é€Ÿ4å€
```

---

## 6. ç®€åŒ–éªŒè¯å™¨è®¾è®¡

### 6.1 è®¾è®¡ç›®æ ‡

- âœ… **ç®€å•**ï¼šä»…ä½¿ç”¨éšæœºé‡‡æ ·+å±€éƒ¨æ‰°åŠ¨ä¸¤ç§æ–¹æ³•
- âœ… **æœ‰æ•ˆ**ï¼šèƒ½å¤Ÿåˆç†è¯„ä¼°çº³ä»€å‡è¡¡è´¨é‡
- âœ… **é«˜æ•ˆ**ï¼šè®¡ç®—æˆæœ¬å¯æ§ï¼ˆçº¦10åˆ†é’Ÿï¼‰
- âœ… **å¯é…ç½®**ï¼šæ”¯æŒä¸åŒçš„è¯•éªŒæ¬¡æ•°ï¼ˆå¿«é€Ÿ/æ ‡å‡†/ä¸¥æ ¼ï¼‰

### 6.2 æ ¸å¿ƒæ¥å£è®¾è®¡

```python
class SimpleNashVerifier:
    """ç®€åŒ–ç‰ˆçº³ä»€å‡è¡¡éªŒè¯å™¨"""

    def __init__(self, env, epsilon=0.05):
        """
        Args:
            env: EVCSChargingGameEnvå¯¹è±¡
            epsilon: Îµ-çº³ä»€å‡è¡¡çš„é˜ˆå€¼ï¼ˆé»˜è®¤5%ï¼‰
        """
        self.env = env
        self.epsilon = epsilon
        self.agents = env.possible_agents
        self.n_periods = env.n_periods  # 8ä¸ªæ—¶æ®µ

    def verify_nash_equilibrium(self, equilibrium_prices,
                                n_random=50, n_perturbation=30):
        """
        éªŒè¯çº³ä»€å‡è¡¡

        Args:
            equilibrium_prices: dict, {agent_id: np.array([p_0, ..., p_7])}
            n_random: int, éšæœºé‡‡æ ·æ¬¡æ•°ï¼ˆé»˜è®¤50ï¼‰
            n_perturbation: int, å±€éƒ¨æ‰°åŠ¨æ¬¡æ•°ï¼ˆé»˜è®¤30ï¼‰

        Returns:
            dict: {
                'is_epsilon_nash': bool,
                'epsilon': float,
                'max_nash_gap': float,
                'avg_nash_gap': float,
                'per_agent_gaps': dict,
                'quality_rating': str
            }
        """
        pass

    def _find_best_deviation(self, agent_id, equilibrium_prices,
                            current_reward, n_random, n_perturbation):
        """ä¸ºå•ä¸ªagentå¯»æ‰¾æœ€ä¼˜åç¦»ç­–ç•¥"""
        pass

    def _try_random_deviation(self, agent_id, equilibrium_prices):
        """éšæœºé‡‡æ ·åç¦»ç­–ç•¥"""
        pass

    def _try_local_perturbation(self, agent_id, equilibrium_prices, sigma):
        """å±€éƒ¨æ‰°åŠ¨"""
        pass
```

### 6.3 è¾“å‡ºæ ¼å¼

```python
result = {
    'is_epsilon_nash': True/False,           # æ˜¯å¦ä¸ºÎµ-çº³ä»€å‡è¡¡
    'epsilon': 0.05,                         # Îµé˜ˆå€¼
    'max_nash_gap': 0.0312,                  # æœ€å¤§Nash Gapï¼ˆæ‰€æœ‰agentä¸­æœ€å¤§çš„ï¼‰
    'avg_nash_gap': 0.0187,                  # å¹³å‡Nash Gap
    'equilibrium_rewards': {                 # å½“å‰å‡è¡¡æ”¶ç›Š
        'agent_0': 3245.60,
        'agent_1': 2987.30,
        'agent_2': 3102.80,
        'agent_3': 2856.10
    },
    'total_revenue': 12191.80,               # æ€»æ”¶ç›Š
    'per_agent_gaps': {                      # æ¯ä¸ªagentçš„è¯¦ç»†ä¿¡æ¯
        'agent_0': {
            'current_reward': 3245.60,
            'best_deviation_reward': 3312.20,
            'best_deviation_prices': [0.52, 0.63, ...],
            'absolute_gap': 66.60,
            'relative_gap': 0.0205,          # Nash Gap
            'has_profitable_deviation': False,
            'deviation_method': 'perturbation_sigma0.05_12'
        },
        # ... å…¶ä»–agent
    },
    'quality_rating': 'è‰¯å¥½ (Good)'           # è´¨é‡è¯„çº§
}
```

---

## 7. è®¡ç®—æˆæœ¬ä¼˜åŒ–ç­–ç•¥

### 7.1 ä¸‰é˜¶æ®µéªŒè¯ç­–ç•¥

```python
# é˜¶æ®µ1ï¼šå¿«é€Ÿç­›æŸ¥ï¼ˆå¼€å‘è°ƒè¯•ï¼‰
n_trials = 20  # æ¯ä¸ªagentåªè¯•20æ¬¡
æˆæœ¬ = 4 Ã— 20 = 80æ¬¡UE-DTA â‰ˆ 2.7åˆ†é’Ÿ

# é˜¶æ®µ2ï¼šæ ‡å‡†éªŒè¯ï¼ˆæ—¥å¸¸å®éªŒï¼‰
n_trials = 80  # æ¯ä¸ªagentè¯•80æ¬¡
æˆæœ¬ = 4 Ã— 80 = 320æ¬¡UE-DTA â‰ˆ 10.7åˆ†é’Ÿ

# é˜¶æ®µ3ï¼šä¸¥æ ¼éªŒè¯ï¼ˆè®ºæ–‡å‘è¡¨ï¼‰
n_trials = 200  # æ¯ä¸ªagentè¯•200æ¬¡
æˆæœ¬ = 4 Ã— 200 = 800æ¬¡UE-DTA â‰ˆ 26.7åˆ†é’Ÿ
```

**æ¨èä½¿ç”¨åœºæ™¯**ï¼š

| é˜¶æ®µ | n_trials | æ—¶é—´ | ä½¿ç”¨åœºæ™¯ |
|------|----------|------|---------|
| å¿«é€Ÿ | 20 | ~3åˆ†é’Ÿ | å¼€å‘è°ƒè¯•ã€å¿«é€Ÿç­›æŸ¥ |
| æ ‡å‡† | 80 | ~11åˆ†é’Ÿ | æ—¥å¸¸å®éªŒã€ç®—æ³•å¯¹æ¯” |
| ä¸¥æ ¼ | 200 | ~27åˆ†é’Ÿ | è®ºæ–‡å‘è¡¨ã€æœ€ç»ˆéªŒè¯ |

### 7.2 å¹¶è¡ŒåŒ–ä¼˜åŒ–ï¼ˆå¯é€‰ï¼‰

```python
# æ ¸å¿ƒæ€æƒ³ï¼š4ä¸ªagentçš„éªŒè¯å¯ä»¥å¹¶è¡Œæ‰§è¡Œ

class ParallelNashVerifier:
    def __init__(self, env_template, epsilon=0.05):
        # ä¸ºæ¯ä¸ªagentåˆ›å»ºç‹¬ç«‹çš„ç¯å¢ƒå‰¯æœ¬
        self.agent_envs = {
            agent_id: env_template.copy()
            for agent_id in env_template.possible_agents
        }

    def verify_parallel(self, equilibrium_prices, n_trials=80):
        """å¹¶è¡ŒéªŒè¯æ‰€æœ‰agent"""
        with ProcessPoolExecutor(max_workers=4) as executor:
            futures = {
                agent_id: executor.submit(
                    verify_single_agent,
                    agent_id,
                    equilibrium_prices,
                    self.agent_envs[agent_id],
                    n_trials
                )
                for agent_id in self.agents
            }

            nash_gaps = {aid: future.result() for aid, future in futures.items()}

        return nash_gaps

# æ€§èƒ½æå‡
ä¸²è¡Œæ—¶é—´ = 4 Ã— 80 Ã— 2ç§’ = 640ç§’ â‰ˆ 10.7åˆ†é’Ÿ
å¹¶è¡Œæ—¶é—´ = 80 Ã— 2ç§’ = 160ç§’ â‰ˆ 2.7åˆ†é’Ÿ  # åŠ é€Ÿ4å€ï¼
```

### 7.3 æ™ºèƒ½æ—©åœï¼ˆæ¿€è¿›ä¼˜åŒ–ï¼‰

```python
def verify_with_early_stopping(equilibrium_prices, epsilon=0.05):
    """
    æ™ºèƒ½æ—©åœï¼šä¸€æ—¦å‘ç°æŸä¸ªagentçš„Nash Gapè¶…è¿‡é˜ˆå€¼ï¼Œç«‹å³åœæ­¢

    é€‚ç”¨åœºæ™¯ï¼šåªæƒ³å¿«é€Ÿåˆ¤æ–­"æ˜¯å¦ä¸ºçº³ä»€å‡è¡¡"ï¼Œä¸éœ€è¦ç²¾ç¡®çš„Gapå€¼
    """
    for agent_id in agents:
        for trial in range(n_trials):
            # å°è¯•åç¦»
            test_reward = ...

            gap = (test_reward - current_reward) / current_reward

            if gap > epsilon:
                print(f"âŒ {agent_id}æœ‰{gap*100:.1f}%æ”¹è¿›ç©ºé—´ï¼Œä¸æ˜¯çº³ä»€å‡è¡¡ï¼")
                return False  # ç«‹å³è¿”å›

        print(f"âœ… {agent_id}éªŒè¯é€šè¿‡")

    return True

# æœ€å¥½æƒ…å†µï¼šç¬¬1ä¸ªagentçš„ç¬¬1æ¬¡å°è¯•å°±å‘ç°è¶…è¿‡é˜ˆå€¼ â†’ åªéœ€1æ¬¡UE-DTAï¼
# æœ€åæƒ…å†µï¼šæ‰€æœ‰agentéƒ½æ»¡è¶³ â†’ ä»éœ€ 4 Ã— 80 = 320æ¬¡
```

---

## 8. MADDPG vs BR-PSO å¯¹æ¯”éªŒè¯

### 8.1 å¯¹æ¯”å®éªŒæµç¨‹

```python
# 1. è®­ç»ƒä¸¤ç§ç®—æ³•
maddpg_prices = train_maddpg()
brpso_prices = train_brpso()

# 2. åˆ›å»ºéªŒè¯å™¨
verifier = SimpleNashVerifier(env, epsilon=0.05)

# 3. éªŒè¯MADDPG
maddpg_result = verifier.verify_nash_equilibrium(
    equilibrium_prices=maddpg_prices,
    n_random=50,
    n_perturbation=30
)

# 4. éªŒè¯BR-PSO
brpso_result = verifier.verify_nash_equilibrium(
    equilibrium_prices=brpso_prices,
    n_random=50,
    n_perturbation=30
)

# 5. å¯¹æ¯”ç»“æœ
comparison = compare_nash_quality(maddpg_result, brpso_result)
```

### 8.2 å¯¹æ¯”ç»´åº¦

**è¡¨æ ¼1ï¼šçº³ä»€å‡è¡¡è´¨é‡å¯¹æ¯”**

| æŒ‡æ ‡ | MADDPG | BR-PSO | è¯´æ˜ |
|------|--------|--------|------|
| Max Nash Gap (%) | 3.2 | 4.5 | BR-PSOç•¥å·®ä½†éƒ½å¯æ¥å— |
| Avg Nash Gap (%) | 1.8 | 2.3 | éƒ½æ˜¯è‰¯å¥½å‡è¡¡ |
| Is 5%-Nash | âœ… | âœ… | éƒ½æ»¡è¶³5%-çº³ä»€å‡è¡¡ |
| Quality Rating | ä¼˜ç§€ | è‰¯å¥½ | MADDPGè´¨é‡æ›´é«˜ |
| Total Revenue | 12,450 | 12,380 | åŸºæœ¬ç›¸å½“ |

**è¡¨æ ¼2ï¼šéªŒè¯æˆæœ¬å¯¹æ¯”**

| ç®—æ³• | è®­ç»ƒæ—¶é—´ | éªŒè¯æ—¶é—´ | éªŒè¯/è®­ç»ƒæ¯” |
|------|---------|---------|-----------|
| MADDPG | 45åˆ†é’Ÿ | 10.7åˆ†é’Ÿ | 23.8% |
| BR-PSO | 180åˆ†é’Ÿ | 10.7åˆ†é’Ÿ | 5.9% |

**ç»“è®º**ï¼š
- éªŒè¯æˆæœ¬ç›¸å¯¹äºè®­ç»ƒæˆæœ¬æ˜¯å¯æ¥å—çš„ï¼ˆ<25%ï¼‰
- ä¸¤ç§ç®—æ³•éƒ½èƒ½æ‰¾åˆ°è‰¯å¥½çš„è¿‘ä¼¼çº³ä»€å‡è¡¡
- MADDPGçš„å‡è¡¡è´¨é‡ç•¥ä¼˜äºBR-PSO

---

## 9. å®ç°è®¡åˆ’

### 9.1 å®ç°ä¼˜å…ˆçº§

**Phase 1ï¼šæœ€å°åŒ–éªŒè¯å™¨ï¼ˆå¿…éœ€ï¼‰**
- [ ] å®ç° `MinimalNashVerifier` ç±»
- [ ] éšæœºé‡‡æ ·æ–¹æ³•
- [ ] å±€éƒ¨æ‰°åŠ¨æ–¹æ³•
- [ ] åŸºæœ¬éªŒè¯æµç¨‹
- [ ] å•å…ƒæµ‹è¯•

**Phase 2ï¼šå®Œæ•´éªŒè¯å™¨ï¼ˆæ¨èï¼‰**
- [ ] å®ç° `SimpleNashVerifier` ç±»
- [ ] è¯¦ç»†çš„è¿›åº¦æ˜¾ç¤º
- [ ] å®Œæ•´çš„ç»“æœæŠ¥å‘Š
- [ ] JSONç»“æœä¿å­˜
- [ ] å¯è§†åŒ–åŠŸèƒ½

**Phase 3ï¼šä¼˜åŒ–ç‰ˆæœ¬ï¼ˆå¯é€‰ï¼‰**
- [ ] å¹¶è¡ŒåŒ–éªŒè¯å™¨
- [ ] æ™ºèƒ½æ—©åœåŠŸèƒ½
- [ ] è‡ªé€‚åº”è¯•éªŒæ¬¡æ•°
- [ ] ç¼“å­˜ä¼˜åŒ–

### 9.2 æ–‡ä»¶ç»“æ„

```
src/
â”œâ”€â”€ verifier/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ minimal_verifier.py      # æœ€å°åŒ–éªŒè¯å™¨
â”‚   â”œâ”€â”€ simple_verifier.py       # ç®€åŒ–ç‰ˆéªŒè¯å™¨
â”‚   â””â”€â”€ parallel_verifier.py     # å¹¶è¡Œç‰ˆéªŒè¯å™¨ï¼ˆå¯é€‰ï¼‰
â””â”€â”€ utils/
    â””â”€â”€ visualization.py          # éªŒè¯ç»“æœå¯è§†åŒ–
```

---

## 10. ä½¿ç”¨ç¤ºä¾‹

### 10.1 åŸºæœ¬ä½¿ç”¨

```python
from src.env.EVCSChargingGameEnv import EVCSChargingGameEnv
from src.verifier.simple_verifier import SimpleNashVerifier

# 1. åˆ›å»ºç¯å¢ƒ
env = EVCSChargingGameEnv('siouxfalls', 'siouxfalls')

# 2. å‡è®¾MADDPGè®­ç»ƒåå¾—åˆ°çš„å‡è¡¡ä»·æ ¼
equilibrium_prices = {
    'agent_0': np.array([0.50, 0.60, 0.80, 0.90, 0.70, 0.60, 0.50, 0.40]),
    'agent_1': np.array([0.45, 0.55, 0.75, 0.85, 0.65, 0.55, 0.45, 0.35]),
    'agent_2': np.array([0.55, 0.65, 0.85, 0.95, 0.75, 0.65, 0.55, 0.45]),
    'agent_3': np.array([0.40, 0.50, 0.70, 0.80, 0.60, 0.50, 0.40, 0.30]),
}

# 3. åˆ›å»ºéªŒè¯å™¨
verifier = SimpleNashVerifier(env, epsilon=0.05)

# 4. æ‰§è¡ŒéªŒè¯
result = verifier.verify_nash_equilibrium(
    equilibrium_prices=equilibrium_prices,
    n_random=50,        # 50æ¬¡éšæœºé‡‡æ ·
    n_perturbation=30   # 30æ¬¡å±€éƒ¨æ‰°åŠ¨
)

# 5. æŸ¥çœ‹ç»“æœ
print(f"æ˜¯å¦ä¸º5%-çº³ä»€å‡è¡¡: {result['is_epsilon_nash']}")
print(f"è´¨é‡è¯„çº§: {result['quality_rating']}")
print(f"Max Nash Gap: {result['max_nash_gap']*100:.2f}%")
```

### 10.2 å¯¹æ¯”ä¸¤ç§ç®—æ³•

```python
# éªŒè¯MADDPG
maddpg_result = verifier.verify_nash_equilibrium(maddpg_prices)

# éªŒè¯BR-PSO
brpso_result = verifier.verify_nash_equilibrium(brpso_prices)

# å¯¹æ¯”
import pandas as pd

comparison = pd.DataFrame({
    'Metric': ['Max Gap (%)', 'Avg Gap (%)', 'Quality'],
    'MADDPG': [
        f"{maddpg_result['max_nash_gap']*100:.2f}",
        f"{maddpg_result['avg_nash_gap']*100:.2f}",
        maddpg_result['quality_rating']
    ],
    'BR-PSO': [
        f"{brpso_result['max_nash_gap']*100:.2f}",
        f"{brpso_result['avg_nash_gap']*100:.2f}",
        brpso_result['quality_rating']
    ]
})

print(comparison.to_markdown(index=False))
```

---

## 11. æ€»ç»“

### 11.1 å…³é”®è¦ç‚¹

| é—®é¢˜ | ç­”æ¡ˆ |
|------|------|
| **ä¸ºä»€ä¹ˆéœ€è¦éªŒè¯ï¼Ÿ** | ç®—æ³•æ”¶æ•› â‰  çº³ä»€å‡è¡¡ï¼Œéœ€è¦å®šé‡è¯„ä¼°è§£çš„è´¨é‡ |
| **éªŒè¯çš„æ ¸å¿ƒé€»è¾‘ï¼Ÿ** | å›ºå®šå…¶ä»–agent â†’ å°è¯•æ”¹å˜å½“å‰agent â†’ çœ‹èƒ½å¦æ”¹è¿› |
| **æ˜¯å¦å¿…é¡»éªŒè¯æ‰€æœ‰agentï¼Ÿ** | âœ… æ˜¯çš„ï¼Œæ‰€æœ‰agentéƒ½æ— åˆ©å¯å›¾çš„åç¦»æ‰æ˜¯çº³ä»€å‡è¡¡ |
| **éªŒè¯æˆæœ¬å¤šå¤§ï¼Ÿ** | æ ‡å‡†éªŒè¯ï¼š4 agents Ã— 80 trials â‰ˆ 10.7åˆ†é’Ÿ |
| **å¦‚ä½•ä¼˜åŒ–ï¼Ÿ** | å‡å°‘trialsã€å¹¶è¡ŒåŒ–ã€æ—©åœ |
| **æ¨èé…ç½®ï¼Ÿ** | å¿«é€Ÿ20æ¬¡ã€æ ‡å‡†80æ¬¡ã€ä¸¥æ ¼200æ¬¡ |

### 11.2 è®¾è®¡åŸåˆ™

1. **ç®€æ´æ€§**ï¼šä»…ä½¿ç”¨éšæœºé‡‡æ ·+å±€éƒ¨æ‰°åŠ¨ä¸¤ç§æ–¹æ³•
2. **æœ‰æ•ˆæ€§**ï¼šè¶³ä»¥è¯„ä¼°çº³ä»€å‡è¡¡è´¨é‡
3. **å¯é…ç½®æ€§**ï¼šæ”¯æŒä¸åŒç²¾åº¦è¦æ±‚çš„éªŒè¯
4. **å¯æ¯”æ€§**ï¼šä¸ºMADDPGå’ŒBR-PSOæä¾›å…¬å¹³å¯¹æ¯”åŸºç¡€

### 11.3 åç»­å·¥ä½œ

- [ ] å®ç°éªŒè¯å™¨ä»£ç 
- [ ] åœ¨MADDPGè®­ç»ƒåé›†æˆéªŒè¯
- [ ] åœ¨BR-PSOè®­ç»ƒåé›†æˆéªŒè¯
- [ ] å¯¹æ¯”å®éªŒå¹¶ç”ŸæˆæŠ¥å‘Š
- [ ] å¯è§†åŒ–éªŒè¯ç»“æœ
