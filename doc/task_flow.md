# 流量观测缩放任务

**日期**: 2026-01-06
**状态**: 配置已完成，代码修改待实施
**关联**: `task_tune.md` P0 修改项

---

## 一、背景

MADDPG 的观测空间包含流量信息：
- `own_charging_flow`: shape `(n_periods,)`，每个时段的充电流量

当前问题：流量未缩放，数值范围 0~数百，与价格 [0.5, 2.0] 量级差异大，影响网络学习。

**目标**：让流量与价格保持相同数量级（不是压缩到 0~1）。

---

## 二、流量统计结果 (2026-01-06)

使用中点价格 (1.25) 运行 UE-DTA，统计各数据集流量分布：

### 2.1 Sioux Falls (4 站点, 8 时段)

| Station | P0 | P1 | P2 | P3 | P4 | P5 | P6 | P7 | Total |
|---------|----|----|----|----|----|----|----|----|-------|
| 5 | 0 | 20 | 35 | 85 | 65 | 35 | 5 | 0 | 245 |
| 12 | 0 | 15 | 35 | 70 | 45 | 25 | 15 | 0 | 205 |
| 14 | 0 | 40 | 80 | 135 | 75 | 50 | 5 | 0 | 385 |
| 18 | 5 | 90 | 225 | 285 | 145 | 50 | 25 | 0 | 825 |

- **Max**: 285 (station 18, P3)
- **非零值 Mean**: 55.6

### 2.2 Berlin Friedrichshain (20 站点, 8 时段)

| Station | P0 | P1 | P2 | P3 | P4 | P5 | P6 | P7 | Total |
|---------|----|----|----|----|----|----|----|----|-------|
| 3 | 5 | 10 | 10 | 0 | 0 | 0 | 0 | 0 | 25 |
| 42 | 20 | 40 | 35 | 0 | 0 | 0 | 0 | 0 | 95 |
| 105 | 20 | **65** | 20 | 0 | 0 | 0 | 0 | 0 | 105 |
| ... | | | | | | | | | |

- **Max**: 65 (station 105, P1)
- **非零值 Mean**: 10.5
- **注意**: P3-P7 时段流量全为 0

### 2.3 Anaheim (40 站点, 8 时段)

| Station | P0 | P1 | P2 | P3 | P4 | P5 | P6 | P7 | Total |
|---------|----|----|----|----|----|----|----|----|-------|
| 62 | 10 | 10 | 10 | 45 | 15 | 0 | 0 | 0 | 90 |
| 73 | 25 | 20 | 20 | 15 | 0 | 0 | 0 | 0 | 80 |
| 269 | 15 | 35 | 10 | 15 | 10 | 0 | 0 | 0 | 85 |
| ... | | | | | | | | | |

- **Max**: 45 (station 62, P3)
- **非零值 Mean**: 11.4
- **注意**: P6-P7 时段流量全为 0

---

## 三、flow_scale_factor 配置方案

### 3.1 配置原则

- 缩放后流量与价格 [0.5, 2.0] 在同一数量级
- 三个数据集的缩放后范围尽量一致

### 3.2 确定的配置值

| 数据集 | flow_scale_factor | 缩放后 Max | 缩放后非零 Mean |
|-------|-------------------|-----------|----------------|
| siouxfalls | **100** | ~2.4 | ~0.6 |
| berlin_friedrichshain | **25** | ~1.0 | ~0.4 |
| anaheim | **20** | ~4.0 | ~0.9 |

### 3.3 实施状态

- [x] 在三个 `settings.json` 中添加 `flow_scale_factor` 配置 ✅
- [ ] 修改 `maddpg.py` 的 `process_observations()` 函数
- [ ] 修改 `maddpg.py` 的 `organize_global_state()` 函数

---

## 四、待处理问题

### 4.1 部分时段流量为 0

**现象**：
- Berlin: P3-P7 (时段 3-7) 流量全为 0
- Anaheim: P6-P7 (时段 6-7) 流量全为 0
- Sioux Falls: P0, P7 部分站点流量为 0

**可能原因**：
1. 仿真时间 (`simulation_time`) 与时段划分 (`charging_periods`) 不匹配
2. 需求时间分布集中在仿真前半段
3. 车辆在后半段还未到达充电站

**影响**：
- 网络输入中大量 0 值
- 后半段时段的价格决策缺乏流量反馈

**待调查**：
- [ ] 检查各数据集的需求时间分布 (demand.csv 中的 start_t, end_t)
- [ ] 验证仿真时间是否足够覆盖所有时段
- [ ] 考虑是否需要调整时段划分或仿真参数

---

## 五、实施计划

1. **修改 settings.json**: 添加 `flow_scale_factor` 配置项
2. **修改 maddpg.py**: `process_observations()` 读取配置并归一化
3. **修改 task_tune.md**: 更新 P0 修改方案的具体实现

---

## 六、修改日志

| 日期 | 内容 |
|-----|------|
| 2026-01-06 | 创建文档，记录流量统计结果和配置方案 |
| 2026-01-06 | 发现部分时段流量为 0 的问题，记录待调查 |
