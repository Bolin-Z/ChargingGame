# 纳什均衡验证实验

**日期**: 2026-01-12
**状态**: 进行中
**背景**: 在 flow_scale 实验中发现 MADDPG/IDDPG 学到中间值解，MFDDPG 学到边界解。需要验证哪个是真正的纳什均衡。

---

## 一、问题背景

### 1.1 实验现状

在 `task_tune.md` 的 P0 流量缩放实验后，三种算法学到了不同的解：

| 算法 | 边界比例 | 价格稳定性 | 最终价格模式 |
|------|---------|-----------|-------------|
| MADDPG | 0% | 0.012-0.015 | 1.1~1.5 中间值 |
| IDDPG | 0% | 0.013-0.015 | 1.1~1.5 中间值 |
| MFDDPG | 100% | 0.03-0.08 | 0.5/2.0 边界值 |

三个随机种子（42, 123, 456）结果高度一致。

### 1.2 核心问题

**哪个解是真正的纳什均衡？**

- MADDPG/IDDPG 的中间值解？
- MFDDPG 的边界解？
- 还是两者都不是？

---

## 二、纳什均衡验证方法

### 2.1 理论基础

**纳什均衡定义**：在均衡点，任何智能体单方面改变策略都**无法获得更高收益**。

**验证方法**：单边偏离测试
1. 固定其他智能体的策略
2. 让一个智能体尝试不同价格
3. 如果偏离后收益增加 → 不是均衡
4. 如果所有偏离都亏损或无变化 → 可能是均衡

### 2.2 测试脚本

`test_unilateral_deviation.py`

测试策略：
- 全部最低价 [0.5, 0.5, ...]
- 全部最高价 [2.0, 2.0, ...]
- 全部中间价 [1.25, 1.25, ...]
- 比基准降低 0.3
- 比基准升高 0.3

判断标准：收益变化 > 1% 视为显著

---

## 三、验证结果

### 3.1 MADDPG 中间值解测试

**基准策略（seed42 最终价格）**：
```
Agent 5:  [1.32, 1.12, 1.36, 1.35, 1.40, 1.22, 1.15, 1.39]
Agent 12: [1.22, 1.04, 1.28, 1.41, 1.25, 1.27, 1.16, 1.08]
Agent 14: [1.44, 1.40, 1.31, 1.37, 1.19, 1.24, 1.19, 1.32]
Agent 18: [1.18, 1.21, 1.12, 1.34, 1.30, 1.31, 1.22, 1.26]
```

**偏离测试结果**：

| 智能体 | 基准收益 | 最佳偏离策略 | 偏离后收益 | 收益变化 |
|-------|---------|-------------|-----------|---------|
| 5 | 12,184 | 降价0.3 | 25,421 | **+108.6%** |
| 12 | 7,105 | 降价0.3 | 19,979 | **+181.2%** |
| 14 | 9,733 | 降价0.3 | 29,089 | **+198.9%** |
| 18 | 30,317 | 中间价1.2 | 44,236 | **+45.9%** |

**结论**：❌ **所有智能体都可以通过偏离获利，不是纳什均衡**

### 3.2 MFDDPG 边界解测试

**基准策略（seed42 最终价格）**：
```
Agent 5:  [2.00, 1.98, 2.00, 1.98, 1.98, 0.52, 1.98, 2.00]
Agent 12: [2.00, 2.00, 2.00, 2.00, 0.50, 2.00, 2.00, 2.00]
Agent 14: [1.99, 1.99, 2.00, 2.00, 1.98, 2.00, 0.50, 2.00]
Agent 18: [2.00, 2.00, 1.97, 0.55, 2.00, 1.98, 1.99, 2.00]
```

**偏离测试结果**：

| 智能体 | 基准收益 | 最佳偏离策略 | 偏离后收益 | 收益变化 |
|-------|---------|-------------|-----------|---------|
| 5 | 9,072 | 中间价1.2 | 18,188 | **+100.5%** |
| 12 | 7,483 | 降价+中间 | 13,453 | **+79.8%** |
| 14 | 6,383 | 降价+中间 | 15,971 | **+150.2%** |
| 18 | 33,802 | 中间价1.2 | 52,646 | **+55.7%** |

**结论**：❌ **所有智能体都可以通过偏离获利，不是纳什均衡**

### 3.3 汇总

| 解 | 是否均衡 | 问题 |
|---|---------|------|
| MADDPG 中间值解 | ❌ 否 | 降价可大幅获利（+45%~+199%） |
| MFDDPG 边界解 | ❌ 否 | 偏离到中间价可大幅获利（+56%~+150%） |

---

## 四、关键发现

### 4.1 两个算法都没找到真正的纳什均衡

- MADDPG/IDDPG 的中间值解：存在强烈的降价动机
- MFDDPG 的边界解：存在向中间移动的动机

### 4.2 中间价格 ~1.2 似乎是更优策略

在两种解上，偏离到中间价格（~1.2）都能获得更高收益：

| 智能体 | MADDPG基准 | MFDDPG基准 | 中间价1.2收益 |
|-------|-----------|-----------|--------------|
| 5 | 12,184 | 9,072 | ~18,000 |
| 12 | 7,105 | 7,483 | ~13,000 |
| 14 | 9,733 | 6,383 | ~15,000 |
| 18 | 30,317 | 33,802 | ~52,000 |

### 4.3 可能的解释

1. **算法训练不够充分**
   - 收敛判断标准（relative_change_rate < 0.01）可能过于宽松
   - 连续5步稳定可能不足以判断真正收敛

2. **真正的均衡可能是混合策略**
   - 纯策略纳什均衡可能不存在
   - 智能体需要随机化定价策略

3. **均衡可能在其他位置**
   - 不在边界，也不在当前的中间值
   - 需要更精细的搜索

4. **博弈结构问题**
   - 用户对价格极度敏感（价格成本 >> 时间成本）
   - 可能导致均衡不稳定或不存在

---

## 五、下一步建议

### 5.1 方案A：网格搜索最优解

在 1.0~1.5 区间进行网格搜索，找到更稳定的均衡点：

```python
# 对每个价格组合运行仿真
# 找到所有智能体都不愿偏离的点
for p5 in [1.0, 1.1, 1.2, 1.3, 1.4, 1.5]:
    for p12 in [1.0, 1.1, 1.2, 1.3, 1.4, 1.5]:
        ...
```

### 5.2 方案B：延长训练

- 增加 max_steps_per_episode 到 3000+
- 使用更严格的收敛标准（如 0.005）
- 增加 stable_steps_required 到 10+

### 5.3 方案C：调整博弈参数

修改 `siouxfalls_settings.json`：
- 增加 `time_value_coefficient`（从 0.005 到 0.01~0.02）
- 使时间成本更有分量，可能产生更稳定的内点均衡

### 5.4 方案D：接受现实

如果博弈本身没有纯策略纳什均衡：
- 改用混合策略求解方法
- 或接受当前解作为"近似均衡"

---

## 六、实验日志

| 日期 | 内容 |
|-----|------|
| 2026-01-12 | 设计单边偏离测试方法 |
| 2026-01-12 | 创建 `test_unilateral_deviation.py` 测试脚本 |
| 2026-01-12 | **关键发现**：MADDPG 和 MFDDPG 的解都不是纳什均衡 |
| 2026-01-12 | 发现中间价格 ~1.2 似乎是更优策略 |

---

## 七、相关文件

- `test_unilateral_deviation.py` - 单边偏离测试脚本
- `analyze_seeds.py` - 多seed实验分析脚本
- `doc/task_tune.md` - MADDPG 调优文档（包含 flow_scale 实验）
