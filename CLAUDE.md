# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## é¡¹ç›®æ¦‚è¿°

è¿™æ˜¯ä¸€ä¸ªåŸºäºŽPythonçš„ç”µåŠ¨æ±½è½¦å……ç”µç«™(EVCS)åšå¼ˆè®ºä»¿çœŸé¡¹ç›®ã€‚**æ ¸å¿ƒç›®æ ‡æ˜¯æ±‚è§£ç”µåŠ¨æ±½è½¦å……ç”µç«™ä»·æ ¼åšå¼ˆä¸­çš„å‡è¡¡è§£**ã€‚

é¡¹ç›®åŒ…å«ä¸¤ä¸ªä¸»è¦ç»„æˆéƒ¨åˆ†ï¼š
1. **åšå¼ˆçŽ¯å¢ƒå®žçŽ°**ï¼šå»ºæ¨¡ç”¨æˆ·å‡è¡¡åŠ¨æ€äº¤é€šåˆ†é…(UE-DTA)ä¸Žå……ç”µç«™å®šä»·ç«žäº‰çš„ä»¿çœŸçŽ¯å¢ƒ
2. **MADRLç®—æ³•å®žçŽ°**ï¼šåŸºäºŽMADDPGæ”¹é€ çš„å¤šæ™ºèƒ½ä½“å¼ºåŒ–å­¦ä¹ ç®—æ³•ï¼Œç”¨äºŽæ±‚è§£ä»·æ ¼å‡è¡¡

## å¼€å‘å‘½ä»¤

```bash
# å®‰è£…ä¾èµ–
pip install -r requirements.txt

# è¿è¡Œä¸»ä»¿çœŸ
python main.py

# è¿è¡ŒæŠ€æœ¯éªŒè¯æµ‹è¯•
python src/technical_validation.py
```

## æ ¸å¿ƒæž¶æž„ä¸Žæ–‡ä»¶ç»“æž„

### ä¸»è¦ç»„ä»¶

- **`src/EVCSChargingGameEnv.py`**: **v3.0æ ¸å¿ƒçŽ¯å¢ƒå®žçŽ°** âœ… **å·²å®Œæˆ**
  - åŸºäºŽv2æ¡†æž¶ + è‡ªçŽ¯å……ç”µé“¾è·¯ + é¢„å®šè·¯å¾„çš„æœ€ç»ˆè®¾è®¡æ–¹æ¡ˆ
  - å®Œæ•´PettingZoo ParallelEnvæŽ¥å£
  - é›†æˆPredefinedRouteVehicle + å¤šçŠ¶æ€å›¾è·¯å¾„ç®—æ³•
  - åŒ…å«å®Œæ•´çš„UE-DTAä»¿çœŸå¾ªçŽ¯å’Œå¥–åŠ±è®¡ç®—ç³»ç»Ÿ

- **`src/EVCSChargingGameEnv_v1.py`**: v1.0ç‰ˆæœ¬å®žçŽ°
  - åŸºäºŽå……ç”µé“¾è·¯å¤åˆ¶çš„åˆå§‹æ–¹æ¡ˆ
  - å®Œæ•´çš„UE-DTAå’Œå¤šæ™ºèƒ½ä½“æŽ¥å£
  - å·²éªŒè¯çš„day-to-dayåŠ¨æ€å‡è¡¡ç®—æ³•

- **`src/EVCSChargingGameEnv_v2.py`**: v2.0ç‰ˆæœ¬å®žçŽ°
  - åŸºäºŽèŠ‚ç‚¹åˆ†ç¦»çš„å®Œæ•´æ¡†æž¶è®¾è®¡
  - v3.0ç»§æ‰¿å…¶PettingZooæŽ¥å£å’ŒUE-DTAç®—æ³•æ¡†æž¶
  - æä¾›v3.0çš„æ•´ä½“ç»“æž„åŸºç¡€

- **`src/technical_validation.py`**: æŠ€æœ¯éªŒè¯è„šæœ¬
  - PredefinedRouteVehicleå’ŒPredefinedRouteWorldç±»å®žçŽ°
  - UXSimè‡ªçŽ¯é“¾è·¯å…¼å®¹æ€§éªŒè¯
  - è·¯å¾„æ‰§è¡Œå®Œæ•´æ€§æµ‹è¯•

- **`main.py`**: ç®€å•å…¥å£ç‚¹ï¼Œåˆå§‹åŒ–çŽ¯å¢ƒ

### ç½‘ç»œæ•°æ®ç»“æž„

ä»¿çœŸä½¿ç”¨å­˜å‚¨åœ¨ `siouxfalls/` ä¸­çš„Sioux Fallsç½‘ç»œæ•°æ®ï¼š
- `siouxfalls_nodes.csv`: å¸¦åæ ‡çš„ç½‘ç»œèŠ‚ç‚¹
- `siouxfalls_links.csv`: å¸¦å®¹é‡å’Œé€Ÿåº¦å‚æ•°çš„é“è·¯é“¾è·¯
- `siouxfalls_demand.csv`: èµ·ç»ˆç‚¹å¯¹ä¹‹é—´çš„äº¤é€šéœ€æ±‚
- `siouxfalls_settings.json`: é…ç½®æ–‡ä»¶ï¼ŒåŒ…æ‹¬å……ç”µèŠ‚ç‚¹å’Œä»·æ ¼è¾¹ç•Œ

## EVCSChargingGameEnv v3.0 è®¾è®¡æ–¹æ¡ˆ

### ðŸŽ¯ æ ¸å¿ƒè®¾è®¡ç†å¿µ

**æ•´ä½“æž¶æž„**: ç»§æ‰¿v2æ¡†æž¶ï¼ˆPettingZooæŽ¥å£ + UE-DTAç®—æ³• + ç±»ç»“æž„ï¼‰
**å……ç”µå»ºæ¨¡**: è‡ªçŽ¯å……ç”µé“¾è·¯ + å¤šçŠ¶æ€å›¾è·¯å¾„ç®—æ³• + PredefinedRouteVehicleä¸¥æ ¼æ‰§è¡Œ

**è®¾è®¡åŽŸåˆ™**:
1. **æ¡†æž¶ç»§æ‰¿**: é‡‡ç”¨v2ç‰ˆæœ¬çš„æˆç†ŸPettingZooæŽ¥å£å’ŒUE-DTAæ¡†æž¶
2. **æ‹“æ‰‘ç®€åŒ–**: ä½¿ç”¨è‡ªçŽ¯å……ç”µé“¾è·¯ï¼Œé¿å…èŠ‚ç‚¹åˆ†ç¦»çš„ç½‘ç»œå¤æ‚æ€§
3. **è·¯å¾„ç²¾ç¡®æŽ§åˆ¶**: å¤šçŠ¶æ€å›¾ç¡®ä¿å……ç”µè½¦è¾†æ°å¥½å……ç”µä¸€æ¬¡
4. **æ‰§è¡Œä¿è¯**: PredefinedRouteVehicleç¡®ä¿ä¸¥æ ¼æŒ‰é¢„å®šè·¯å¾„è¡Œé©¶
5. **è½¦è¾†æ•°ç»Ÿè®¡**: deltanæ¦‚å¿µç¡®ä¿æ‰€æœ‰ç»Ÿè®¡æ˜¾ç¤ºå®žé™…è½¦è¾†æ•°é‡

### ðŸš— å…³é”®æ¦‚å¿µï¼šdeltanï¼ˆè½¦è¾†æ‰¹æ¬¡å¤§å°ï¼‰

**deltan**æ˜¯UXSimä¸­çš„å…³é”®å‚æ•°ï¼Œå®šä¹‰äº†æ¯ä¸ªVehicleå¯¹è±¡ä»£è¡¨å¤šå°‘è¾†å®žé™…è½¦è¾†ã€‚è¿™æ˜¯ä¸€ä¸ª"platoon"ï¼ˆè½¦é˜Ÿï¼‰æ¦‚å¿µï¼š

- **å®šä¹‰**: `deltan` = æ¯ä¸ªVehicleå¯¹è±¡ä»£è¡¨çš„å®žé™…è½¦è¾†æ•°é‡
- **ä½œç”¨**: å‡å°‘ä»¿çœŸè®¡ç®—é‡ï¼Œæé«˜å¤§è§„æ¨¡äº¤é€šç½‘ç»œä»¿çœŸæ•ˆçŽ‡
- **ç»Ÿè®¡å½±å“**: æ‰€æœ‰è½¦è¾†æ•°ç»Ÿè®¡éƒ½éœ€è¦ä¹˜ä»¥deltanæ‰æ˜¯å®žé™…è½¦è¾†æ•°é‡

**v3.0ä¸­çš„deltanå¤„ç†**:
- âœ… æ‰€æœ‰æ˜¾ç¤ºçš„è½¦è¾†æ•°ç»Ÿè®¡éƒ½æ˜¯å®žé™…è½¦è¾†æ•°ï¼ˆVehicleå¯¹è±¡æ•° Ã— deltanï¼‰
- âœ… tqdmè¿›åº¦æ¡æ˜¾ç¤ºå®žé™…è½¦è¾†æ•°
- âœ… æ”¶æ•›/æœªæ”¶æ•›æ¶ˆæ¯æ˜¾ç¤ºå®žé™…è½¦è¾†æ•°
- âœ… æœ€ç»ˆç»Ÿè®¡è¡¨æ ¼æ˜¾ç¤ºå®žé™…è½¦è¾†æ•°
- âœ… å……ç”µæµé‡ç»Ÿè®¡è€ƒè™‘deltanå½±å“

**ç¤ºä¾‹**:
```python
# å¦‚æžœåˆ›å»ºäº†100ä¸ªVehicleå¯¹è±¡ï¼Œdeltan=5
vehicle_objects = 100
deltan = 5
actual_vehicles = vehicle_objects * deltan  # 500è¾†å®žé™…è½¦è¾†

# v3.0ä¸­æ‰€æœ‰åœ°æ–¹æ˜¾ç¤ºçš„éƒ½æ˜¯500ï¼Œè€Œä¸æ˜¯100
```

### ðŸ§ª æŠ€æœ¯éªŒè¯ç»“æžœ

#### âœ… UXSimè‡ªçŽ¯é“¾è·¯å®Œå…¨å…¼å®¹
åŸºäºŽ `src/technical_validation.py` çš„éªŒè¯æµ‹è¯•è¡¨æ˜Žï¼š

```python
# æµ‹è¯•è·¯å¾„ï¼ˆåŒ…å«è‡ªçŽ¯A-Aï¼‰
predefined_route = ["A-B", "B-A", "A-A", "A-B", "B-A", "A-C"]

# éªŒè¯ç»“æžœ
Actual route:     ['A-B', 'B-A', 'A-A', 'A-B', 'B-A', 'A-C'] 
Predefined route: ['A-B', 'B-A', 'A-A', 'A-B', 'B-A', 'A-C']
Completion progress: 100.0%
Unfinished vehicles: 0
```

#### âœ… PredefinedRouteVehicleå…³é”®ç‰¹æ€§
1. **100%è·¯å¾„åŒ¹é…**: å®žé™…è¡Œé©¶è·¯å¾„ä¸Žé¢„å®šè·¯å¾„å®Œå…¨ä¸€è‡´
2. **è‡ªçŽ¯æ”¯æŒ**: UXSimåŽŸç”Ÿæ”¯æŒè‡ªçŽ¯é“¾è·¯ï¼ˆX-Xæ ¼å¼ï¼‰
3. **å®ŒæˆçŽ‡ä¿è¯**: æ‰€æœ‰è½¦è¾†æŒ‰é¢„å®šè·¯å¾„å®Œæˆè¡Œç¨‹
4. **è·¯å¾„çµæ´»æ€§**: æ”¯æŒä»»æ„å¤æ‚çš„è·¯å¾„åºåˆ—ï¼ŒåŒ…æ‹¬è‡ªçŽ¯

### ðŸ—ï¸ v3.0æž¶æž„è®¾è®¡

#### 1. è‡ªçŽ¯å……ç”µé“¾è·¯åˆ›å»º
```python
# ä¸ºæ¯ä¸ªå……ç”µèŠ‚ç‚¹åˆ›å»ºè‡ªçŽ¯å……ç”µé“¾è·¯
def _create_charging_links(self):
    for charging_node_idx in self._charging_nodes.keys():
        charging_link_name = f"charging_{charging_node_idx}"
        self.W.addLink(
            name=charging_link_name,
            start_node=charging_node_idx,
            end_node=charging_node_idx,  # è‡ªçŽ¯ï¼šèµ·ç‚¹=ç»ˆç‚¹
            length=self._charging_link_length,
            free_flow_speed=self._charging_link_free_flow_speed,
            attribute={"charging_link": True}
        )
```

#### 2. å¤šçŠ¶æ€å›¾è·¯å¾„ç®—æ³•
```python
def _enumerate_k_shortest_charge_routes(self, source, target, k):
    """åŸºäºŽå¤šçŠ¶æ€å›¾çš„å……ç”µè·¯å¾„æžšä¸¾ï¼Œç¡®ä¿æ°å¥½ä¸€æ¬¡å……ç”µ"""
    G = nx.DiGraph()
    
    # æž„å»ºå¤šçŠ¶æ€å›¾
    for link in self.W.LINKS:
        start, end = link.start_node.name, link.end_node.name
        
        if link.attribute.get("charging_link", False):
            # è‡ªçŽ¯å……ç”µé“¾è·¯ï¼šçŠ¶æ€è½¬æ¢ uncharged -> charged
            node_idx = start  # è‡ªçŽ¯èµ·ç‚¹=ç»ˆç‚¹
            G.add_edge(f"uncharged_{node_idx}", f"charged_{node_idx}", 
                      weight=link.length/link.u, link_name=link.name)
        else:
            # æ™®é€šé“¾è·¯ï¼šçŠ¶æ€ä¿æŒ
            G.add_edge(f"uncharged_{start}", f"uncharged_{end}", 
                      weight=link.length/link.u, link_name=link.name)
            G.add_edge(f"charged_{start}", f"charged_{end}", 
                      weight=link.length/link.u, link_name=link.name)
    
    # è·¯å¾„æœç´¢ï¼šuncharged_source -> charged_target
    paths = nx.shortest_simple_paths(G, f"uncharged_{source}", f"charged_{target}", weight='weight')
    
    # è½¬æ¢ä¸ºå®žé™…é“¾è·¯åºåˆ—ï¼Œä¾›PredefinedRouteVehicleä½¿ç”¨
    routes = []
    for path in islice(paths, k):
        route = [G[path[i]][path[i+1]]['link_name'] for i in range(len(path)-1)]
        routes.append(route)
    
    return routes
```

#### 3. PredefinedRouteVehicleé›†æˆ
```python
# ç»§æ‰¿v2æ¡†æž¶ï¼Œé›†æˆé¢„å®šè·¯å¾„è½¦è¾†
class EVCSGameEnv(ParallelEnv):  # ç»§æ‰¿v2çš„åŸºç¡€ç»“æž„
    def _create_simulation_world(self):
        """åˆ›å»ºæ”¯æŒé¢„å®šè·¯å¾„çš„ä»¿çœŸä¸–ç•Œ"""
        W = PredefinedRouteWorld(name="EVCS_Simulation", **simulation_params)
        
        # å¤åˆ¶ç½‘ç»œç»“æž„ï¼ˆåŒ…æ‹¬è‡ªçŽ¯å……ç”µé“¾è·¯ï¼‰
        self._copy_network_to_world(W)
        
        # ä¸ºæ¯è¾†è½¦åˆ†é…é¢„å®šè·¯å¾„
        for vehicle_id, route_links in self.routes_specified.items():
            veh = W.addVehicle(
                predefined_route=route_links,  # å®Œæ•´é“¾è·¯åºåˆ—ï¼ŒåŒ…å«è‡ªçŽ¯charging_links
                departure_time=self.departure_times[vehicle_id],
                name=vehicle_id
            )
```

#### 4. å……ç”µè¡Œä¸ºç‰©ç†å»ºæ¨¡
```python
# é€šè¿‡è‡ªçŽ¯é“¾è·¯å‚æ•°æŽ§åˆ¶å……ç”µæ—¶é—´ï¼ˆä»…ä½¿ç”¨settings.jsonä¸­é…ç½®çš„å‚æ•°ï¼‰
charging_link_parameters = {
    "length": 3000,              # 3kmï¼Œæ¥è‡ªsettings.jsonçš„charging_link_length
    "free_flow_speed": 10,       # 10m/sï¼Œæ¥è‡ªsettings.jsonçš„charging_link_free_flow_speed
}
```

### ðŸŽ® PettingZooçŽ¯å¢ƒæŽ¥å£è®¾è®¡ï¼ˆç»§æ‰¿v2æ¡†æž¶ï¼‰

#### è§‚æµ‹ç©ºé—´
```python
def observation_space(self, agent):
    return spaces.Dict({
        "last_round_all_prices": spaces.Box(low=0.0, high=1.0, shape=(self.n_agents, self.n_periods)),
        "own_charging_flow": spaces.Box(low=0, high=np.inf, shape=(self.n_periods,))
    })
```

#### åŠ¨ä½œç©ºé—´
```python
def action_space(self, agent):
    return spaces.Box(low=0.0, high=1.0, shape=(self.n_periods,))
```

#### å¥–åŠ±å‡½æ•°
```python
reward_i = Î£(æ—¶æ®µ_jçš„ä»·æ ¼ Ã— æ—¶æ®µ_jçš„å……ç”µè½¦è¾†æ•°é‡)  # å¯¹äºŽæ™ºèƒ½ä½“i
```

### ðŸ“Š Day-to-DayåŠ¨æ€å‡è¡¡ç®—æ³•ï¼ˆç»§æ‰¿v2æ¡†æž¶ï¼‰

#### UE-DTAæ±‚è§£æµç¨‹
1. **è·¯å¾„é¢„è®¡ç®—**: ä½¿ç”¨å¤šçŠ¶æ€å›¾ä¸ºæ‰€æœ‰ODå¯¹é¢„è®¡ç®—kæ¡å……ç”µ/éžå……ç”µè·¯å¾„
2. **è·¯å¾„åˆå§‹åŒ–**: ä¸ºè½¦è¾†åˆ†é…åˆå§‹é¢„å®šè·¯å¾„ï¼ˆå……ç”µè½¦è¾†ç¡®ä¿åŒ…å«æ°å¥½ä¸€æ¡è‡ªçŽ¯å……ç”µé“¾è·¯ï¼‰
3. **ä»¿çœŸæ‰§è¡Œ**: ä½¿ç”¨PredefinedRouteVehicleä¸¥æ ¼æŒ‰é¢„å®šè·¯å¾„ä»¿çœŸ
4. **æˆæœ¬è®¡ç®—**: åŸºäºŽå®žé™…æ—…è¡Œæ—¶é—´å’Œå……ç”µä»·æ ¼è®¡ç®—æ€»æˆæœ¬
5. **è·¯å¾„åˆ‡æ¢**: æ ¹æ®æˆæœ¬å·®å¼‚å’Œéšæœºæ¦‚çŽ‡è¿›è¡Œè·¯å¾„è°ƒæ•´
6. **æ”¶æ•›åˆ¤æ–­**: åŸºäºŽå¹³å‡æˆæœ¬å·®åˆ¤æ–­æ˜¯å¦è¾¾åˆ°å‡è¡¡

#### æˆæœ¬å‡½æ•°
```python
# å……ç”µè½¦è¾†ï¼ˆæ£€æµ‹åˆ°è‡ªçŽ¯charging_é“¾è·¯ï¼‰
æ€»æˆæœ¬ = time_value_coefficient Ã— å®žé™…æ—…è¡Œæ—¶é—´ + å……ç”µä»·æ ¼ Ã— charging_demand_per_vehicle

# éžå……ç”µè½¦è¾†  
æ€»æˆæœ¬ = time_value_coefficient Ã— å®žé™…æ—…è¡Œæ—¶é—´
```

## ðŸƒ v3.0å½“å‰å®žçŽ°çŠ¶æ€

### âœ… å·²å®Œæˆçš„æ ¸å¿ƒåŠŸèƒ½ï¼ˆæˆªè‡³2025å¹´1æœˆï¼‰

**âœ… å®Œæ•´çš„v3.0å®žçŽ°ï¼ˆPhase 1-8å…¨éƒ¨å®Œæˆï¼‰ï¼š**

**PettingZooçŽ¯å¢ƒæŽ¥å£å±‚ï¼ˆPhase 4ï¼‰ï¼š**
- âœ… ä»·æ ¼åˆå§‹åŒ–ç³»ç»Ÿï¼šæ”¯æŒéšæœºå’Œä¸­ç‚¹åˆå§‹åŒ–æ¨¡å¼
- âœ… è§‚æµ‹ç©ºé—´å®žçŽ°ï¼šlast_round_all_prices + own_charging_flow
- âœ… åŠ¨ä½œç©ºé—´å®žçŽ°ï¼š[0,1]å½’ä¸€åŒ–ä»·æ ¼åŠ¨ä½œ
- âœ… ä»·æ ¼å½’ä¸€åŒ–ï¼šå®žé™…ä»·æ ¼ â†” [0,1]åŒºé—´æ˜ å°„  
- âœ… çŽ¯å¢ƒç”Ÿå‘½å‘¨æœŸï¼šreset()å’Œstep()æ–¹æ³•å®Œæ•´å®žçŽ°
- âœ… æ”¶æ•›æ£€æµ‹ï¼šåŸºäºŽL2èŒƒæ•°çš„ä»·æ ¼å˜åŒ–æ£€æµ‹

**ç½‘ç»œå’Œè·¯å¾„åŸºç¡€è®¾æ–½ï¼ˆPhase 1-3ï¼‰ï¼š**
- âœ… è‡ªçŽ¯å……ç”µé“¾è·¯åˆ›å»ºï¼šcharging_{node_id} (nodeâ†’node)
- âœ… å¤šçŠ¶æ€å›¾è·¯å¾„ç®—æ³•ï¼šuncharged/chargedçŠ¶æ€è½¬æ¢
- âœ… PredefinedRouteVehicleé›†æˆï¼šæŠ€æœ¯éªŒè¯å®Œæˆ
- âœ… å……ç”µ/éžå……ç”µè·¯å¾„æžšä¸¾ï¼škæœ€çŸ­è·¯å¾„è®¡ç®—

**è·¯å¾„åˆ†é…ä¸Žè½¦è¾†ç®¡ç†ï¼ˆPhase 5ï¼‰ï¼š**
- âœ… __create_simulation_worldï¼šåˆ›å»ºæ”¯æŒé¢„å®šè·¯å¾„çš„ä»¿çœŸä¸–ç•Œ
- âœ… __initialize_routesï¼šè½¦è¾†åˆ†ç±»ä¸Žåˆå§‹è·¯å¾„åˆ†é…
- âœ… __apply_routes_to_vehiclesï¼šPredefinedRouteVehicleè½¦è¾†åˆ›å»º

**UE-DTAä»¿çœŸé›†æˆï¼ˆPhase 6ï¼‰ï¼š**
- âœ… __run_simulationï¼šå®Œæ•´UE-DTAä»¿çœŸå¾ªçŽ¯é›†æˆ
- âœ… __route_choice_updateï¼šè·¯å¾„é€‰æ‹©æ›´æ–°å’Œç»Ÿè®¡
- âœ… __estimate_route_costï¼šè·¯å¾„æˆæœ¬ä¼°ç®—
- âœ… __calculate_actual_vehicle_cost_and_flowï¼šæˆæœ¬è®¡ç®—å’Œå……ç”µæµé‡ç»Ÿè®¡

**å……ç”µæµé‡ç»Ÿè®¡ä¸Žå¥–åŠ±è®¡ç®—ï¼ˆPhase 7ï¼‰ï¼š**
- âœ… __calculate_rewardsï¼šåŸºäºŽä»·æ ¼Ã—æµé‡çš„å¥–åŠ±è®¡ç®—
- âœ… è‡ªçŽ¯å……ç”µé“¾è·¯æ£€æµ‹ï¼šä»Žtraveled_routeè¯†åˆ«å……ç”µè¡Œä¸º
- âœ… æŒ‰æ—¶æ®µç»Ÿè®¡å„å……ç”µç«™æµé‡ï¼šæ”¯æŒdeltanè½¦è¾†æ•°é‡æ¦‚å¿µ

**ç”¨æˆ·ä½“éªŒä¼˜åŒ–ï¼ˆPhase 8ï¼‰ï¼š**
- âœ… tqdmè¿›åº¦æ¡ï¼šè¯¦ç»†çš„UE-DTAæ”¶æ•›è¿‡ç¨‹æ˜¾ç¤º
- âœ… æ”¶æ•›/æœªæ”¶æ•›æ¶ˆæ¯ï¼šä½¿ç”¨pbar.write()æ˜¾ç¤ºè¯¦ç»†ç»Ÿè®¡
- âœ… æœ€ç»ˆç»Ÿè®¡è¡¨æ ¼ï¼šTexttableæ˜¾ç¤ºå®žé™…è½¦è¾†æ•°é‡ç»Ÿè®¡
- âœ… å®žé™…è½¦è¾†æ•°ç»Ÿè®¡ï¼šæ‰€æœ‰æ˜¾ç¤ºå‡ä¸ºVehicleå¯¹è±¡æ•°Ã—deltan

### ðŸŽ‰ v3.0å®žçŽ°å®Œæˆï¼

EVCSChargingGameEnv v3.0å·²å®Œå…¨å®žçŽ°ï¼ŒåŒ…æ‹¬ï¼š
- å®Œæ•´PettingZoo ParallelEnvæŽ¥å£
- è‡ªçŽ¯å……ç”µé“¾è·¯å»ºæ¨¡
- å¤šçŠ¶æ€å›¾è·¯å¾„ç®—æ³•
- PredefinedRouteVehicleä¸¥æ ¼è·¯å¾„æ‰§è¡Œ
- UE-DTAåŠ¨æ€å‡è¡¡ä»¿çœŸ
- å……ç”µæµé‡ç»Ÿè®¡å’Œå¥–åŠ±è®¡ç®—
- è¯¦ç»†çš„è¿›åº¦æ˜¾ç¤ºå’Œç»Ÿè®¡ä¿¡æ¯

## ðŸ“‹ v3.0å®žçŽ°TODOæ¸…å•

### ðŸ Phase 1: çŽ¯å¢ƒæ¡†æž¶æ­å»ºï¼ˆç»§æ‰¿v2ï¼Œé¢„è®¡1å¤©ï¼‰âœ… **å·²å®Œæˆ**
- [x] **1.1 å¤åˆ¶v2åŸºç¡€æ¡†æž¶**
  - [x] ä»ŽEVCSChargingGameEnv_v2.pyå¤åˆ¶ç±»ç»“æž„å’ŒPettingZooæŽ¥å£
  - [x] ä¿ç•™observation_space, action_space, reset, stepç­‰æ ¸å¿ƒæ–¹æ³•æ¡†æž¶
  - [x] ä¿ç•™UE-DTAç®—æ³•çš„åŸºç¡€ç»“æž„å’Œå‚æ•°ç®¡ç†

- [x] **1.2 é›†æˆPredefinedRouteVehicle**
  - [x] ä»Žtechnical_validation.pyå¤åˆ¶PredefinedRouteVehicleå’ŒPredefinedRouteWorldç±»
  - [x] é€‚é…åˆ°EVCSGameEnvçš„ç½‘ç»œåˆ›å»ºå’Œè½¦è¾†ç®¡ç†æµç¨‹
  - [x] æ”¯æŒå»¶è¿Ÿè·¯å¾„åˆ†é…å’ŒLinkå¯¹è±¡åˆ—è¡¨è½¬æ¢

### ðŸ”— Phase 2: è‡ªçŽ¯å……ç”µé“¾è·¯å®žçŽ°ï¼ˆé¢„è®¡1å¤©ï¼‰âœ… **å·²å®Œæˆ**
- [x] **2.1 ç½‘ç»œåŠ è½½ä¸Žè‡ªçŽ¯é“¾è·¯åˆ›å»º**
  - [x] ä¿®æ”¹ç½‘ç»œåŠ è½½é€»è¾‘ï¼Œç§»é™¤èŠ‚ç‚¹åˆ†ç¦»ç›¸å…³ä»£ç 
  - [x] å®žçŽ°è‡ªçŽ¯å……ç”µé“¾è·¯åˆ›å»ºï¼šcharging_idx (idx->idx)
  - [x] è®¾ç½®å……ç”µé“¾è·¯ç‰©ç†å‚æ•°ï¼ˆä»…ä½¿ç”¨settings.jsoné…ç½®ï¼‰

- [x] **2.2 ç½‘ç»œéªŒè¯**
  - [x] éªŒè¯è‡ªçŽ¯å……ç”µé“¾è·¯æ­£ç¡®åˆ›å»º
  - [x] ç¡®è®¤UXSimå¯¹è‡ªçŽ¯é“¾è·¯çš„å…¼å®¹æ€§
  - [x] æµ‹è¯•åŸºç¡€ç½‘ç»œè¿žé€šæ€§

### ðŸ›£ï¸ Phase 3: å¤šçŠ¶æ€å›¾è·¯å¾„ç®—æ³•ï¼ˆé¢„è®¡2å¤©ï¼‰âœ… **å·²å®Œæˆ**
- [x] **3.1 å¤šçŠ¶æ€å›¾æž„å»º**
  - [x] å®žçŽ°uncharged/chargedçŠ¶æ€èŠ‚ç‚¹ç”Ÿæˆ
  - [x] æ™®é€šé“¾è·¯ï¼šçŠ¶æ€ä¿æŒè¾¹ï¼ˆuncharged->uncharged, charged->chargedï¼‰
  - [x] å……ç”µé“¾è·¯ï¼šçŠ¶æ€è½¬æ¢è¾¹ï¼ˆuncharged->chargedï¼‰

- [x] **3.2 å……ç”µè·¯å¾„æžšä¸¾ç®—æ³•**
  - [x] å®žçŽ°__enumerate_k_shortest_charge_routesæ–¹æ³•
  - [x] è·¯å¾„æœç´¢ï¼šuncharged_sourceåˆ°charged_target
  - [x] å¤šçŠ¶æ€å›¾è·¯å¾„è½¬æ¢ä¸ºå®žé™…é“¾è·¯åºåˆ—

- [x] **3.3 éžå……ç”µè·¯å¾„æžšä¸¾ç®—æ³•**
  - [x] å®žçŽ°__enumerate_k_shortest_routesæ–¹æ³•ï¼ˆæŽ’é™¤å……ç”µé“¾è·¯ï¼‰
  - [x] ç¡®ä¿éžå……ç”µè½¦è¾†ä¸ä¼šç»è¿‡charging_é“¾è·¯

### ðŸŽ® Phase 4: PettingZooçŽ¯å¢ƒæŽ¥å£å®žçŽ°ï¼ˆé¢„è®¡1å¤©ï¼‰âœ… **å·²å®Œæˆ**
- [x] **4.1 åŸºç¡€çŽ¯å¢ƒæŽ¥å£**
  - [x] å®žçŽ°__init_charging_pricesæ–¹æ³•ï¼šæ”¯æŒéšæœºå’Œä¸­ç‚¹åˆå§‹åŒ–æ¨¡å¼
  - [x] å®žçŽ°__get_observationsæ–¹æ³•ï¼šç”Ÿæˆç¬¦åˆè§‚æµ‹ç©ºé—´çš„æ™ºèƒ½ä½“è§‚æµ‹
  - [x] å®žçŽ°__normalize_pricesæ–¹æ³•ï¼šå°†å®žé™…ä»·æ ¼å½’ä¸€åŒ–åˆ°[0,1]åŒºé—´
  - [x] å®žçŽ°__update_prices_from_actionsæ–¹æ³•ï¼šä»ŽåŠ¨ä½œæ›´æ–°ä»·æ ¼åŽ†å²

- [x] **4.2 çŽ¯å¢ƒç”Ÿå‘½å‘¨æœŸç®¡ç†**
  - [x] å®žçŽ°resetæ–¹æ³•ï¼šçŽ¯å¢ƒé‡ç½®ï¼Œæ¸…ç†çŠ¶æ€ï¼Œç”Ÿæˆåˆå§‹è§‚æµ‹
  - [x] å®žçŽ°stepæ–¹æ³•æ¡†æž¶ï¼šå®Œæ•´çš„çŽ¯å¢ƒæ­¥éª¤æµç¨‹
  - [x] å®žçŽ°__check_convergenceæ–¹æ³•ï¼šåŸºäºŽL2èŒƒæ•°çš„ä»·æ ¼æ”¶æ•›æ£€æŸ¥
  - [x] å®žçŽ°actions_to_pricesæ–¹æ³•ï¼šåŠ¨ä½œåˆ°å®žé™…ä»·æ ¼çš„æ˜ å°„

### ðŸš— Phase 5: è·¯å¾„åˆ†é…ä¸Žè½¦è¾†ç®¡ç†ï¼ˆé¢„è®¡2å¤©ï¼‰âœ… **å·²å®Œæˆ**
- [x] **5.1 è·¯å¾„é¢„è®¡ç®—ä¸Žç¼“å­˜**
  - [x] ä¸ºæ‰€æœ‰ODå¯¹é¢„è®¡ç®—å……ç”µå’Œéžå……ç”µè·¯å¾„é›†åˆ
  - [x] å®žçŽ°è·¯å¾„ç¼“å­˜æœºåˆ¶ï¼Œé¿å…é‡å¤è®¡ç®—
  - [x] éªŒè¯è·¯å¾„è´¨é‡ï¼šè¿žé€šæ€§ã€å……ç”µé“¾è·¯åŒ…å«æ€§ç­‰

- [x] **5.2 è½¦è¾†åˆ†ç±»ä¸Žè·¯å¾„åˆ†é…**
  - [x] åŸºäºŽcharging_car_rateè¿›è¡Œè½¦è¾†åˆ†ç±»
  - [x] ä¸ºå……ç”µè½¦è¾†åˆ†é…åŒ…å«æ°å¥½ä¸€æ¡è‡ªçŽ¯å……ç”µé“¾è·¯çš„è·¯å¾„
  - [x] ä¸ºéžå……ç”µè½¦è¾†åˆ†é…æ™®é€šæœ€çŸ­è·¯å¾„

- [x] **5.3 PredefinedRouteVehicleè½¦è¾†åˆ›å»º**
  - [x] åœ¨__create_simulation_worldä¸­é›†æˆé¢„å®šè·¯å¾„è½¦è¾†åˆ›å»º
  - [x] ç¡®ä¿æ¯è¾†è½¦èŽ·å¾—å®Œæ•´çš„é¢„å®šè·¯å¾„åºåˆ—
  - [x] æµ‹è¯•è½¦è¾†æŒ‰é¢„å®šè·¯å¾„ä¸¥æ ¼æ‰§è¡Œ

### âš–ï¸ Phase 6: UE-DTAä»¿çœŸé›†æˆï¼ˆé¢„è®¡2å¤©ï¼‰âœ… **å·²å®Œæˆ**
- [x] **6.1 Worldå®žä¾‹ç®¡ç†**
  - [x] æ¯stepåˆ›å»ºæ–°PredefinedRouteWorldå®žä¾‹
  - [x] å¤åˆ¶ç½‘ç»œç»“æž„ï¼ˆåŒ…æ‹¬è‡ªçŽ¯å……ç”µé“¾è·¯ï¼‰åˆ°æ–°World
  - [x] åº”ç”¨å½“å‰å……ç”µä»·æ ¼åˆ°è‡ªçŽ¯å……ç”µé“¾è·¯

- [x] **6.2 Day-to-dayå‡è¡¡è¿­ä»£**
  - [x] å®žçŽ°UEè¿­ä»£å¾ªçŽ¯æ¡†æž¶(__run_simulation)
  - [x] æˆæœ¬è®¡ç®—ï¼šè¯†åˆ«è‡ªçŽ¯å……ç”µé“¾è·¯ï¼Œåº”ç”¨å……ç”µä»·æ ¼
  - [x] è·¯å¾„åˆ‡æ¢é€»è¾‘ï¼šåŸºäºŽæˆæœ¬å·®å¼‚çš„éšæœºåˆ‡æ¢(__route_choice_update)
  - [x] æ”¶æ•›åˆ¤æ–­ï¼šå¹³å‡æˆæœ¬å·®å°äºŽé˜ˆå€¼

### ðŸ“Š Phase 7: å……ç”µæµé‡ç»Ÿè®¡ä¸Žå¥–åŠ±è®¡ç®—ï¼ˆé¢„è®¡1å¤©ï¼‰âœ… **å·²å®Œæˆ**
- [x] **7.1 è‡ªçŽ¯å……ç”µé“¾è·¯æ£€æµ‹**
  - [x] ä»Žvehicle.traveled_route()è¯†åˆ«charging_é“¾è·¯è®¿é—®
  - [x] æå–å……ç”µæ—¶åˆ»å’Œå……ç”µèŠ‚ç‚¹ä¿¡æ¯
  - [x] æŒ‰æ—¶æ®µåˆ†ç»„ç»Ÿè®¡å„å……ç”µç«™æµé‡

- [x] **7.2 å¥–åŠ±å‡½æ•°å®žçŽ°**
  - [x] åŸºäºŽä»·æ ¼Ã—æµé‡è®¡ç®—å„agentæ”¶ç›Š(__calculate_rewards)
  - [x] æž„å»ºå¥–åŠ±å­—å…¸è¿”å›žç»™PettingZooæŽ¥å£
  - [x] éªŒè¯å¥–åŠ±è®¡ç®—çš„æ­£ç¡®æ€§

### ðŸ§ª Phase 8: æµ‹è¯•éªŒè¯ä¸Žä¼˜åŒ–ï¼ˆé¢„è®¡2å¤©ï¼‰âœ… **å·²å®Œæˆ**
- [x] **8.1 å……ç”µè¡Œä¸ºéªŒè¯**
  - [x] ç¡®è®¤å……ç”µè½¦è¾†ä¸¥æ ¼æŒ‰é¢„å®šè·¯å¾„è¡Œé©¶
  - [x] éªŒè¯è‡ªçŽ¯å……ç”µé“¾è·¯è®¿é—®ï¼šæ°å¥½ä¸€æ¬¡å……ç”µ
  - [x] æ£€æŸ¥å……ç”µæµé‡ç»Ÿè®¡å‡†ç¡®æ€§

- [x] **8.2 çŽ¯å¢ƒå®Œæ•´æ€§æµ‹è¯•**
  - [x] å¤šè½®reset-stepå¾ªçŽ¯æµ‹è¯•
  - [x] ä»·æ ¼æ”¶æ•›æœºåˆ¶éªŒè¯
  - [x] PettingZooæŽ¥å£å…¼å®¹æ€§å…¨é¢æµ‹è¯•

- [x] **8.3 ç”¨æˆ·ä½“éªŒä¼˜åŒ–**
  - [x] tqdmè¿›åº¦æ¡æ˜¾ç¤ºè¯¦ç»†UE-DTAæ”¶æ•›è¿‡ç¨‹
  - [x] æ”¶æ•›å’Œæœªæ”¶æ•›æ¶ˆæ¯ä½¿ç”¨pbar.write()è¾“å‡º
  - [x] æœ€ç»ˆç»Ÿè®¡è¡¨æ ¼æ˜¾ç¤ºå®žé™…è½¦è¾†æ•°é‡
  - [x] æ‰€æœ‰è½¦è¾†æ•°ç»Ÿè®¡ä¸€è‡´æ€§ï¼šVehicleå¯¹è±¡æ•°Ã—deltan

### ðŸ“š åŽç»­ä¼˜åŒ–æ–¹å‘ï¼ˆå¯é€‰ï¼‰
- **æ€§èƒ½ä¼˜åŒ–**ï¼šUE-DTAæ±‚è§£æ•ˆçŽ‡åˆ†æžå’Œä¼˜åŒ–ã€å†…å­˜ä½¿ç”¨ä¼˜åŒ–
- **åŸºå‡†æµ‹è¯•**ï¼šåˆ›å»ºæ ‡å‡†æµ‹è¯•åœºæ™¯ã€æ€§èƒ½åŸºå‡†æµ‹è¯•
- **å¯¹æ¯”åˆ†æž**ï¼šä¸Žv1.0/v2.0çš„æ€§èƒ½å’Œå‡†ç¡®æ€§å¯¹æ¯”

## ä¾èµ–é¡¹

- **UXSim**: äº¤é€šå¾®è§‚ä»¿çœŸæ¡†æž¶ (v1.8.2)
- **NetworkX**: è·¯å¾„è®¡ç®—çš„å›¾ç®—æ³•
- **PettingZoo**: å¤šæ™ºèƒ½ä½“å¼ºåŒ–å­¦ä¹ çŽ¯å¢ƒæ¡†æž¶
- **Gymnasium**: çŽ¯å¢ƒæŽ¥å£æ ‡å‡†
- **NumPy/Pandas**: æ•°æ®æ“ä½œå’Œåˆ†æž
- **PyTorch**: MADRLçš„æ·±åº¦å­¦ä¹ æ¡†æž¶
- **Matplotlib**: å¯è§†åŒ–å’Œç»˜å›¾

## é…ç½®æ–‡ä»¶å‚æ•°

çŽ¯å¢ƒä»Ž `siouxfalls_settings.json` è¯»å–é…ç½®ï¼š

```json
{
    // åŸºç¡€åšå¼ˆé…ç½®
    "charging_nodes": {"5": [0.1, 1.0], "12": [0.1, 1.0], "14": [0.1, 1.0], "18": [0.1, 1.0]},
    "charging_periods": 8,
    "charging_car_rate": 0.3,
    "routes_per_od": 5,
    
    // è‡ªçŽ¯å……ç”µé“¾è·¯ç‰©ç†å‚æ•°
    "charging_link_length": 3000,
    "charging_link_free_flow_speed": 10,
    
    // UE-DTAæ±‚è§£å‚æ•°
    "time_value_coefficient": 0.005,
    "charging_demand_per_vehicle": 50,
    "ue_convergence_threshold": 1.0,
    "ue_max_iterations": 100,
    "ue_swap_probability": 0.05,
    
    // ä»¿çœŸæŽ§åˆ¶å‚æ•°
    "simulation_time": 7200,
    "deltan": 5  // Platoonå¤§å°ï¼šæ¯ä¸ªVehicleå¯¹è±¡ä»£è¡¨çš„å®žé™…è½¦è¾†æ•°
}
```

### é‡è¦æ¦‚å¿µè¯´æ˜Ž

**deltanï¼ˆPlatoonæ¦‚å¿µï¼‰**ï¼š
- UXsimä¸­çš„å…³é”®å‚æ•°ï¼Œå®šä¹‰äº†æ¯ä¸ªVehicleå¯¹è±¡ä»£è¡¨å¤šå°‘è¾†å®žé™…è½¦è¾†
- ä¾‹å¦‚deltan=5æ—¶ï¼Œä¸€ä¸ªVehicleå¯¹è±¡ä»£è¡¨5è¾†å®žé™…è½¦è¾†
- åœ¨ç»Ÿè®¡è½¦è¾†æ•°é‡ã€å……ç”µæµé‡æ—¶éœ€è¦ä¹˜ä»¥deltanèŽ·å¾—å®žé™…æ•°å€¼
- å½±å“ä»¿çœŸç²¾åº¦ä¸Žè®¡ç®—æ•ˆçŽ‡çš„å¹³è¡¡
```

## å…³é”®æŠ€æœ¯å†³ç­–è®°å½•

### v3.0 vs v1.0/v2.0 è®¾è®¡å¯¹æ¯”

| æ–¹é¢ | v1.0 (å……ç”µé“¾è·¯å¤åˆ¶) | v2.0 (èŠ‚ç‚¹åˆ†ç¦») | v3.0 (v2æ¡†æž¶+è‡ªçŽ¯+é¢„å®šè·¯å¾„) |
|------|-------------------|----------------|------------------------------|
| **æ•´ä½“æž¶æž„** | åŸºç¡€å®žçŽ° | å®Œæ•´PettingZooæ¡†æž¶ | ç»§æ‰¿v2æ¡†æž¶ |
| **å……ç”µé“¾è·¯** | å¤åˆ¶çŽ°æœ‰é“¾è·¯ä¸ºcharging_ç‰ˆæœ¬ | å†…éƒ¨é“¾è·¯è¿žæŽ¥åˆ†ç¦»èŠ‚ç‚¹ | çœŸæ­£è‡ªçŽ¯ï¼šidx->idx |
| **è·¯å¾„æŽ§åˆ¶** | ä¾èµ–UXSimè·¯å¾„é€‰æ‹© | å¤šçŠ¶æ€å›¾è·¯å¾„æŽ§åˆ¶ | å¤šçŠ¶æ€å›¾+PredefinedRouteVehicle |
| **ç½‘ç»œæ‹“æ‰‘** | é“¾è·¯æ•°ç¿»å€ | èŠ‚ç‚¹æ•°ç¿»å€+å†…éƒ¨é“¾è·¯ | ä»…å¢žåŠ è‡ªçŽ¯ï¼Œæœ€ç®€æ´ |
| **å……ç”µä¿è¯** | åŒå±‚å›¾æ¦‚çŽ‡ä¿è¯ | å¼ºåˆ¶æ°å¥½ä¸€æ¬¡ | é¢„å®šè·¯å¾„100%ä¿è¯ |
| **å®žçŽ°å¤æ‚åº¦** | ä¸­ç­‰ | é«˜ | ä¸­ç­‰ï¼ˆç»§æ‰¿v2æ¡†æž¶ï¼‰ |

### v3.0æ ¸å¿ƒä¼˜åŠ¿

1. **æž¶æž„æˆç†Ÿ**: ç»§æ‰¿v2çš„å®Œæ•´PettingZooæŽ¥å£å’ŒUE-DTAæ¡†æž¶ï¼Œé¿å…é‡å¤å¼€å‘
2. **æ‹“æ‰‘æœ€ç®€**: è‡ªçŽ¯å……ç”µé“¾è·¯æ˜¯æ‰€æœ‰æ–¹æ¡ˆä¸­ç½‘ç»œæ‹“æ‰‘æœ€ç®€æ´çš„
3. **æŽ§åˆ¶ç²¾ç¡®**: å¤šçŠ¶æ€å›¾+é¢„å®šè·¯å¾„åŒé‡ä¿è¯å……ç”µè¡Œä¸ºçš„ç¡®å®šæ€§
4. **æ‰©å±•ä¾¿åˆ©**: åŸºäºŽv2æ¡†æž¶ï¼Œæ˜“äºŽåŽç»­åŠŸèƒ½æ‰©å±•å’Œç®—æ³•é›†æˆ
5. **éªŒè¯å……åˆ†**: PredefinedRouteVehicleå·²é€šè¿‡æŠ€æœ¯éªŒè¯ï¼Œç¡®ä¿è·¯å¾„æ‰§è¡Œå¯é æ€§

### éšæœºç§å­ç®¡ç†ç­–ç•¥

- **çŽ¯å¢ƒåˆå§‹åŒ–**: ä¼ å…¥ç»Ÿä¸€random_seedå‚æ•°æŽ§åˆ¶æ‰€æœ‰éšæœºæ“ä½œ
- **ä»·æ ¼åˆå§‹åŒ–**: ä½¿ç”¨ç§å­æŽ§åˆ¶åˆå§‹ä»·æ ¼ç”Ÿæˆ
- **UXSimä»¿çœŸ**: æ¯è½®è®¾ç½®ç›¸åŒç§å­ç¡®ä¿å¯å¤çŽ°æ€§
- **è·¯å¾„åˆ‡æ¢**: UEç®—æ³•ä¸­çš„éšæœºåˆ‡æ¢ä½¿ç”¨ç§å­æŽ§åˆ¶

## å¼€å‘æ³¨æ„äº‹é¡¹

- é¡¹ç›®å…¨ç¨‹ä½¿ç”¨ä¸­æ–‡æ³¨é‡Šå’Œå˜é‡å
- é»˜è®¤é…ç½®INFOçº§åˆ«æ—¥å¿—ï¼Œå…³é”®æ­¥éª¤è¾“å‡ºè°ƒè¯•ä¿¡æ¯
- çŽ¯å¢ƒæ”¯æŒå……ç”µå’Œéžå……ç”µè½¦è¾†æ··åˆä»¿çœŸ
- ä½¿ç”¨çŽ¯å¢ƒåˆå§‹åŒ–å‚æ•°ä¸­çš„éšæœºç§å­è¿›è¡Œå®Œå…¨å¯å¤çŽ°çš„ä»¿çœŸ
- v3.0å®žçŽ°ä½äºŽ `src/EVCSChargingGameEnv.py`ï¼Œä¿æŒä¸Žé…ç½®æ–‡ä»¶æ ¼å¼å®Œå…¨å…¼å®¹
- ä¸¥æ ¼éµå¾ªPettingZoo ParallelEnvæŽ¥å£è§„èŒƒï¼Œç¡®ä¿MADRLç®—æ³•å…¼å®¹æ€§
- å……ç”µé“¾è·¯å‘½åè§„èŒƒï¼š`charging_{node_idx}` ç”¨äºŽè‡ªçŽ¯é“¾è·¯ `{node_idx} -> {node_idx}`