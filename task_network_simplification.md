# 任务简报：柏林路网简化与充电站布局优化

## 1. 背景与动机
用户指出当前的柏林 Friedrichshain 交通网络数据（`berlin_friedrichshain`）存在**微观节点冗余**现象。具体表现为：
- 许多距离极近的节点聚集在同一个路口（例如一个路口由 4 个小节点构成）。
- 这种拓扑结构增加了计算复杂度，且对充电站选址（宏观决策）造成干扰。

目标是通过**节点空间聚合**技术简化网络，使其拓扑结构更清晰，更符合宏观交通仿真的需求。

## 2. 任务目标
1.  **路网清洗 (Simplification)**：将距离小于特定阈值（建议 50米）的节点合并为一个逻辑超级节点。
2.  **数据一致性维护**：确保在合并节点后，相关联的数据（OD需求、链路连接、节点坐标）能够正确映射到新节点。
3.  **充电站重新选址**：基于简化后的新路网，重新计算最优的 20 个充电站布局。

## 3. 核心步骤规划

### 步骤一：实施路网简化脚本 (`simplify_network.py`)
-   **输入**：原始的 `_nodes.csv`, `_links.csv`, `_demand.csv`。
-   **算法**：
    1.  **Union-Find 聚类**：遍历所有链路，若两端节点距离 < **50m**，则将其加入同一集合。
    2.  **中心点计算**：对于每个集合（超级节点），计算其几何中心作为新坐标。
    3.  **ID 映射**：建立 `old_node_id -> new_super_node_id` 的映射表。
-   **重构输出**：
    -   **Nodes**: 仅保留超级节点。
    -   **Links**: 
        -   更新 Start/End 节点 ID。
        -   **自环处理**：删除 Start == End 的内部微观链路。
        -   **多重边合并**：若两个超级节点间存在多条链路，合并其属性（如容量相加、速度取平均）。
    -   **Demand**: 将原始 OD 需求累加到对应的超级节点上。

### 步骤二：验证简化效果
-   **统计指标**：
    -   简化前后节点数量对比（预期：201 -> ~170）。
    -   简化前后链路数量对比。
    -   孤立节点检查。
-   **可视化验证**：(可选) 生成对比图，直观展示聚合情况。

### 步骤三：重新生成设置文件 (`create_settings.py`)
-   基于简化后的 `nodes.csv` 和 `links.csv`。
-   使用 **Furthest Point Sampling (最远点采样)** 算法。
-   选择 **20 个** 分布均匀的超级节点作为充电站。
-   更新 `berlin_friedrichshain_settings.json`。

## 4. 预期成果
-   一套更干净、更高效的柏林交通网络数据集。
-   一个经过空间优化的、包含 20 个站点的充电站布局方案。
-   训练与仿真效率的提升。

## 5. 后续行动建议
用户确认后，即可开始编写并执行 `simplify_network.py`。
