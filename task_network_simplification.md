# 柏林路网简化数据集 - 完成记录

## 1. 数据集概览

已完成 `berlin_friedrichshain_simplified` 数据集构建。

| 指标 | 数值 |
|-----|------|
| 节点数 | 191 |
| 链路数 | 451 |
| OD对数 | 506 |
| 充电站数 | 20 |
| 路网总长度 | 167.8 km |

## 2. 关键参数

### 2.1 空间聚合
- **聚合阈值**: 50.0m
- **节点缩减**: 224 → 191 (减少 14.7%)

### 2.2 需求倍数
经过仿真测试，确定最佳需求倍数：

| 倍数 | 完成率 | 平均速度 | 延误比 | 评价 |
|-----|-------|---------|-------|------|
| 1x | 100% | 28.0 m/s | 14% | 无拥堵 |
| 3x | 100% | 10.5 m/s | 78% | 轻度拥堵 |
| **3.5x** | **100%** | **7.4 m/s** | **88%** | **推荐** |
| 4x | 81% | 4.1 m/s | 93% | 较重拥堵 |
| 5x | 42% | 2.5 m/s | 92% | 严重拥堵 |

**推荐配置**: `demand_multiplier = 3.5`
- 100% 完成率
- 明显的高峰拥堵效果
- 仿真结束前网络可恢复

## 3. 文件结构

```
berlin_friedrichshain_simplified/
├── nodes.csv          # 节点坐标
├── links.csv          # 链路数据 (name, start, end, length, u, kappa)
├── demand.csv         # OD需求 (orig, dest, start_t, end_t, q)
├── settings.json      # 仿真配置 (含20个充电站)
└── uxsim.py           # UXSim源码参考
```

## 4. 使用方式

```python
# 测试脚本
python test_berlin_simplified.py

# 在博弈环境中使用时，需要放大需求
demand_multiplier = 3.5
W.adddemand(orig, dest, start_t, end_t, q * demand_multiplier)
```

## 5. 进阶实验与数据集扩展规划

### 5.1 Berlin Friedrichshain (BF) 优化策略

**定位**: 真实场景模拟、数字孪生展示、微观博弈特征验证。

**挑战**: BF 路网呈现微观"管状"车流特征（OD 稀疏），随机放置的充电站极易因不在特定通勤路径上而导致**零流量**，使智能体无法学习。

**执行方案**:
1.  **维持压力**: 严格锁定 `demand_multiplier = 3.5`。
    *   *注*: 实测 4x 以上会导致网络完全死锁（Gridlock），无法进行有效的博弈仿真。
2.  **智能选址 (Smart Placement)**: ✅ 已完成
    *   先运行一次无博弈的纯交通仿真。
    *   统计全网 Link 的累计通行流量。
    *   将充电站部署在**流量最大的 Top 20 节点**上（而非随机分布）。
    *   *目的*: 确保博弈有"生源"，观察主干道拥堵时支路站点的定价引流策略。

#### 5.1.1 智能选址分析结果 (2024-12)

**分析方法对比**:

| 方案 | 方法 | 与原方案重叠 | 流量覆盖 | 提升 |
|-----|------|------------|---------|------|
| 原方案 | 基于节点度数 | - | 822,175 车次 | 基准 |
| 方案A | 基于链路流量Top20端点 | 2个 | 1,102,650 车次 | +34.1% |
| **方案B** | **基于节点流量Top20** | **3个** | **1,591,275 车次** | **+93.5%** |

**最终选址 (方案B - 已采用)**:

节点ID: `3, 12, 21, 39, 42, 46, 56, 58, 59, 64, 68, 79, 105, 107, 124, 154, 163, 165, 167, 172`

**Top 10 高流量节点**:

| 排名 | 节点 | 流量(车次) |
|-----|------|-----------|
| 1 | 107 | 110,600 |
| 2 | 163 | 110,500 |
| 3 | 172 | 100,400 |
| 4 | 39 | 94,450 |
| 5 | 58 | 94,250 |
| 6 | 12 | 82,550 |
| 7 | 56 | 81,600 |
| 8 | 167 | 80,150 |
| 9 | 21 | 73,175 |
| 10 | 59 | 72,900 |

**分析工具**: `analyze_station_placement.py`
**可视化输出**: `data/berlin_friedrichshain/station_placement_comparison.png`

#### 5.1.2 BF 网络 completed_ratio 问题与参数调优 (2025-12)

**问题发现**：在运行 `compare_convergence_metrics.py` 进行 UE-DTA 收敛分析时，发现 BF 网络的 `completed_ratio`（车辆完成率）极低。

**原配置** (`simulation_time=7200, demand_multiplier=3.5`)：

| 指标 | 数值 |
|-----|------|
| completed_ratio | 27.9% ~ 43.3%, avg **37.2%** |
| 问题 | 超过 60% 车辆未完成行程 |

**根因分析**：

| 参数 | 当前值 | 问题 |
|-----|-------|------|
| 发车时间 | 0 ~ 3600s (第1小时) | 所有车辆集中在第1小时发车 |
| 仿真时间 | 7200s (2小时) | 只剩1小时给晚发车的车辆完成行程 |
| 延误比 | 88% (3.5x) | 实际行驶时间 ≈ 自由流的 8 倍 |
| 充电时间 | 300s (5分钟) | 额外延迟 |

**注意**：2.2 节中的需求倍数测试是**无充电场景**的纯交通仿真，加入充电自环链路后有效容量下降。

**参数调优过程**：

| 配置 | completed_ratio | Global Mean | 评价 |
|-----|-----------------|-------------|------|
| 7200s, 3.5x (原) | avg **37%** | 最终 4.7% | 严重问题 |
| 9000s, 3.0x | avg **44%** | 最终 6.1% | 改善有限 |
| **10800s, 2.5x** | avg **78%**, 6轮达100% | avg 7.4% | **推荐** |

**最终推荐配置**：

```json
{
    "simulation_time": 10800,
    "demand_multiplier": 2.5
}
```

**残留问题**：
- completed_ratio 仍有波动（59%~100%），源于路径切换导致的拥堵波动
- Global Mean 在 5%~13% 之间振荡，无法收敛到 2%
- **根本原因**：随机切换机制的固有缺陷（详见 5.2.9 节）

**结论**：BF 网络的 completed_ratio 问题通过参数调优有所改善，但未彻底解决（详见 5.1.3 节）。

#### 5.1.3 completed_ratio 波动问题深入分析 (2025-12)

**问题发现**：使用 `compare_convergence_metrics.py` 进行 100 轮 UE-DTA 测试时，发现 BF 和 Anaheim 网络的 completed_ratio 无法稳定达到 100%。

**当前配置与测试数据**：

| 网络 | simulation_time | demand_multiplier | 发车时间 | completed_ratio |
|------|-----------------|-------------------|----------|-----------------|
| Sioux Falls | 9600s | 1.0 | 0~3600s | 98%~100% ✅ |
| Berlin | 10800s | 2.5 | 0~3600s | **27%~34%** ❌ |
| Anaheim | 10800s | 0.5 | 0~4800s | 87%~96% ⚠️ |

*注：metrics_comparison 100轮测试数据，bf_test_10800s_2.5x 20轮测试为 59%~100%*

**根因分析**：

| 因素 | 说明 |
|------|------|
| 发车集中 | 所有车辆在前 1~1.3 小时内发车 |
| 路径切换波动 | 某轮大量车辆切换到同一路径 → 该路径拥堵加剧 |
| 超时未完成 | 晚发车车辆在拥堵波动下无法在仿真结束前完成行程 |

**核心结论**：completed_ratio 波动与 UE-DTA 收敛振荡（5.2.9 节）是**同一根源**——随机切换机制导致的系统不稳定。

**解决思路**：

| 方向 | 方案 | 优点 | 缺点 |
|------|------|------|------|
| A. 治标 | 延长 simulation_time 到 14400s+ | 简单，无需改代码 | 增加计算时间，不解决根本问题 |
| **B. 治本** | **实现 5.2.10 节方案 C（Gap-based + 衰减切换）** | **同时解决两个问题** | 需要代码改动 |

**推荐方案**：优先实现方向 B。切换概率改进会让系统稳定在均衡附近，拥堵波动减小后 completed_ratio 自然稳定。如仍不稳定，再考虑延长仿真时间作为补充。

### 5.2 UE-DTA 参数调优 ✅ 已完成

**目标**: 确定 `time_value_coefficient` 和 `ue_convergence_threshold` 的合理配置。

#### 5.2.1 参数含义

- `time_value_coefficient`: 时间价值系数（元/秒）
  - **0.005 元/秒 = 18 元/小时**，对应现实最低时薪标准
  - 此参数具有现实锚定意义，**不应随意调整**
- `ue_convergence_threshold`: UE收敛阈值，影响收敛精度与计算时间

#### 5.2.2 测试结果 (2024-12)

**测试工具**: `test_ue_convergence.py`

**Berlin Friedrichshain 结果** (`time_value_coefficient = 0.005`):

| ue_threshold | UE迭代 | 时间成本 | 充电成本 | 比例 | 耗时 |
|--------------|--------|----------|----------|------|------|
| 0.5 | 1 | 1.15 | 64.20 | 0.02:1 | 13s |
| **1.0** | **1** | **1.15** | **64.20** | **0.02:1** | **13s** |
| 2.0 | 1 | 1.15 | 64.20 | 0.02:1 | 13s |

**Sioux Falls 结果** (`time_value_coefficient = 0.005`):

| ue_threshold | UE迭代 | 时间成本 | 充电成本 | 比例 | 耗时 |
|--------------|--------|----------|----------|------|------|
| 0.5 | 9 | 9.02 | 67.26 | 0.13:1 | 122s |
| **1.0** | **3** | **9.75** | **68.08** | **0.14:1** | **40s** |
| 2.0 | 1 | 10.39 | 68.58 | 0.15:1 | 14s |

#### 5.2.3 关键发现

**充电成本主导是合理的**：

| 场景 | 特征 | 博弈意义 |
|------|------|----------|
| 时间成本→0 | 所有站点同质 | 纯Bertrand竞争，无差异化 |
| 时间成本主导 | 位置决定一切 | 空间垄断，价格竞争无效 |
| **当前(0.02~0.15:1)** | **充电成本主导，时间提供差异化** | **合理的空间差异化竞争** |

- 充电是**刚需**，充电成本（几十元）作为主要决策因素是现实的
- 时间成本（几元）作为**差异化因素**，不需要与充电成本等量
- 只要时间成本不为零，空间差异化博弈就有意义

#### 5.2.4 推荐配置

**两个网络统一配置**:
```json
{
    "time_value_coefficient": 0.005,
    "ue_convergence_threshold": 1.0,
    "charging_demand_per_vehicle": 50
}
```

| 网络 | UE迭代 | 耗时 | 说明 |
|------|--------|------|------|
| **Sioux Falls** | 3次 | 40s | 精度与效率平衡 |
| **Berlin** | 1次 | 13s | 快速收敛 |

**参数选择理由**:
- `time_value_coefficient = 0.005`: 锚定现实时薪，具有经济学意义
- `ue_convergence_threshold = 1.0`: 平衡收敛精度与计算效率
- `charging_demand_per_vehicle = 50`: 反映真实充电需求量级

**已完成**:
- [x] 运行参数扫描测试
- [x] 分析时间成本 vs 充电成本比例
- [x] 确定推荐参数值
- [x] 确认充电成本主导的合理性

#### 5.2.5 UE-DTA 收敛逻辑分析 ✅ 已完成

**问题背景**：BF 网络在 `ue_convergence_threshold = 1.0` 下仅 1 轮 UE-DTA 迭代即判定收敛，需验证是否为"伪均衡"。

**当前收敛逻辑**：
```python
# 使用所有车辆的平均 cost_gap 作为收敛判断
if stats['all_avg_cost_gap'] < self.ue_convergence_threshold:
    break
```

**潜在问题**："全局平均"可能掩盖局部不均衡：
- 90% 车辆已在最优路径（cost_gap=0）
- 10% 车辆有较大改进空间（cost_gap=5）
- 全局平均 = 0.5 → 判定收敛，但部分 OD 对未达均衡

**UXSim 原实现对比**：
- UXSim 的 `SolverDUE.solve()` **不自动判断收敛**，固定运行 `max_iter` 次
- 仅记录 `t_gap_per_vehicle` 作为监控指标，由用户事后判断

**改进方案选项**：

| 方案 | 收敛条件 | 优点 | 缺点 |
|------|----------|------|------|
| A. 按OD分组最大值 | `max(各OD的avg_gap) < 阈值` | 确保每个OD内部均衡 | 可能过严，迭代次数增加 |
| B. 百分位数 | `P90(all_gaps) < 阈值` | 容忍少数离群值 | 需调整阈值 |
| C. 固定迭代 | 固定5-10次，不自动停止 | 与UXSim一致 | 效率可能降低 |

**分析工具**：`analyze_od_cost_gap.py`

**使用方式**：
```bash
# 分析 BF 网络的 OD 级别 cost_gap 分布
python analyze_od_cost_gap.py --network berlin_friedrichshain --iterations 10

# 分析 SF 网络
python analyze_od_cost_gap.py --network siouxfalls --iterations 10
```

**输出**：`od_cost_gap_analysis_{network}.json`

**关键输出指标**：
- `global_avg_cost_gap`: 当前使用的全局平均
- `od_level_max_avg_gap`: 按OD分组后的最大平均值
- `ratio`: 两者比值，>2-3 说明存在被掩盖的局部不均衡
- `high_gap_ods`: 持续高 gap 的 OD 对列表

**已完成**：
- [x] 运行 BF 和 SF 网络的 OD 级别分析
- [x] 判断是否存在"伪均衡"

#### 5.2.6 分析结果 (2024-12)

**BF vs SF 网络对比**：

| 指标 | Sioux Falls | Berlin |
|------|-------------|--------|
| 第1轮 global_avg | 1.505 (>1.0, 不收敛) | 0.298 (<1.0, 判定收敛) |
| 第1轮 od_max_avg | 17.575 | 4.116 |
| ratio (od_max/global) | 11.7x | 13.8x |
| 第50轮 global_avg | 0.107 | 0.105 |
| 第50轮 od_max_avg | **2.425** (下降) | **2.4~9.3** (波动) |

**关键发现**：
- **BF存在伪均衡**：global_avg=0.298看似收敛，但od_max_avg=4.116，ratio=13.8x
- **SF能真正收敛**：od_max_avg从17.6稳定下降到2.4
- **BF无法真正收敛**：od_max_avg在4-9之间波动，管状路网特征导致部分OD无法改善

#### 5.2.7 改进方案设计

**问题根源**：当前使用**绝对成本差**（元），不同网络成本量级不同，同一阈值效果差异大。

**方案对比**：

| 方案 | 描述 | 优点 | 缺点 |
|------|------|------|------|
| A. 加min_iterations | 至少迭代N轮再判断收敛 | 简单，改动小 | 治标不治本 |
| B. 按OD分组最大值 | `max(各OD的avg_gap) < 阈值` | 确保局部均衡 | BF永不收敛 |
| **C. 相对成本差** | `(current-best)/current < 阈值%` | 尺度无关，跨网络通用 | 改动较大 |

**推荐方案C：相对成本差（百分比）**

```python
# 当前：绝对成本差
cost_gap = current_cost - best_cost  # 单位：元

# 改为：相对成本差
relative_gap = (current_cost - best_cost) / current_cost  # 单位：%
```

**优势**：
- **尺度不变性**：0-100%统一范围，不依赖成本量级
- **跨网络可比**：BF和SF可使用同一阈值
- **物理意义清晰**："还能省X%"比"还能省X元"更直观

**阈值建议**：
- 5% = 宽松（快速收敛）
- 2% = 适中（推荐）
- 1% = 严格（更多迭代）

**收敛条件**：
```python
avg_relative_gap = mean((current - best) / current for all vehicles)
if avg_relative_gap < 0.02:  # 平均改进空间 < 2%
    converged = True
```

**已完成**：
- [x] 实现相对成本差计算 (Relative Cost Gap)
  - [x] 核心计算逻辑：`gap_percent = (current - best) / current`
  - [x] 聚合指标实现：Global Mean, OD-based Max Mean, P95
- [x] 分析多种聚合指标在 BF 和 SF 网络上的表现 (避免伪均衡)
- [x] 确定最终的收敛判据 (如：双重标准)
- [ ] 更新 settings.json 配置格式

#### 5.2.8 三网络收敛指标对比实验 ✅ 已完成 (2024-12)

**实验工具**: `compare_convergence_metrics.py`

**实验设计**:
- 固定价格 (ratio=0.5)，观察纯 UE-DTA 收敛行为
- 三种聚合指标：Global Mean (GM), OD Max Mean, P95
- 迭代次数：100轮 + 300轮（BF/Anaheim）

**100轮迭代结果**:

| 网络 | GM最终值 | P95最终值 | ODMax最终值 | GM<2%轮数 | 备注 |
|-----|---------|----------|------------|----------|------|
| **Sioux Falls** | 0.69% | 3.91% | 9.40% | 14轮 | 收敛良好 |
| **Berlin** | 4.96% | 28.95% | 50.67% | >100 | 无法收敛 |
| **Anaheim** | 3.12% | 18.87% | 72.65% | >100 | 接近收敛 |

**300轮迭代结果 (BF/Anaheim)**:

| 网络 | GM最终值 | P95最终值 | ODMax最终值 | 备注 |
|-----|---------|----------|------------|------|
| **Berlin** | 4.68% | 29.05% | 65.03% | 几乎无改善 |
| **Anaheim** | 3.09% | 18.69% | 78.12% | 几乎无改善 |

**平台期振荡分析** (关键发现):

| 网络 | 指标 | 100轮 | 200轮 | 300轮 | 趋势 |
|-----|------|-------|-------|-------|------|
| **BF** | GM | 4.96% | 4.17% | 4.68% | 振荡 ↗↘ |
| **BF** | P95 | 28.95% | 24.14% | 29.05% | 振荡 ↗↘ |
| **Anaheim** | GM | 3.12% | 2.85% | 3.09% | 振荡 ↗↘ |
| **Anaheim** | P95 | 18.87% | 17.74% | 18.69% | 振荡 ↗↘ |

**关键发现**:
1. **OD Max 不适合作为收敛判据**：对小样本OD的随机波动过于敏感，在随机切换机制下永远无法稳定
2. **振荡是随机切换的固有缺陷**：200轮时指标更好，300轮反而变差，系统在均衡点附近持续抖动
3. **继续迭代无意义**：两个网络都进入振荡平台期，不是单调收敛

**双重标准收敛轮数**:

| 标准 | SF | Anaheim | BF |
|-----|----|---------|----|
| GM<2% + P95<10% | 18轮 | >300 | >300 |
| GM<5% + P95<20% | 9轮 | **38轮** | 244轮 |
| GM<5% + P95<25% | - | 28轮 | 84轮 |
| GM<5% + P95<30% | - | 20轮 | 44轮 |

**最终收敛标准建议 (分层阈值)**:

| 网络类型 | 收敛标准 | 预期轮数 | 说明 |
|---------|---------|---------|------|
| 理论网络 (SF) | GM<2% + P95<10% | ~20轮 | 严格标准 |
| 真实网络 (Anaheim) | GM<5% + P95<20% | ~40轮 | 适中标准 |
| 管状网络 (BF) | GM<5% + P95<30% | ~50轮 | 宽松标准 |

#### 5.2.9 UE-DTA 核心机制升级：基于 uedta.py 的改进

当前实现参考了 UXSim 官方示例 `uedta.py`。虽然 `uedta.py` 能够模拟 Day-to-Day 的动态演化，但其“固定概率切换”机制导致系统在迭代后期难以消除随机震荡，使得 P95 和 OD Max 指标无法稳定下降。

针对博弈训练对**环境稳定性**（Stable Reward Signal）的高要求，决定引入 **Gap-based (差距敏感)** 和 **MSA (衰减步长)** 机制。

**对比分析表**：

| 对比维度 | 当前方案 (参考 uedta.py) | 推荐改进方案 (Gap-based + MSA) | 对博弈项目的核心价值 |
| :--- | :--- | :--- | :--- |
| **核心机制** | **固定概率切换 (Fixed Probability)**<br>无论第几轮，始终以固定概率 (如 5%) 换路 | **衰减步长 + 差距敏感**<br>概率随轮数衰减 (MSA)，且与节省成本的比例成正比 | **强制收敛**<br>消除迭代后期的随机震荡，确保 P95/OD Max 指标能降到极低阈值。 |
| **切换逻辑** | **一视同仁**<br>只要有更优路径，节省 1% 和节省 50% 的切换概率完全相同 | **理性切换 (Gap-based)**<br>节省越多，切换概率越大<br>`Prob = min(1.0, α * Gap)` | **降低 OD Max**<br>防止微小的成本差异引发大规模的流量“搬家”，抑制局部过热。 |
| **迭代后期** | **持续噪点**<br>系统永远不会停止尝试，导致解在均衡点附近持续“抖动” | **逐渐冻结 (MSA)**<br>随着迭代增加，强制降低切换上限<br>`Prob = C / (C + n)` | **稳定 Reward 信号**<br>为 RL 智能体提供确定性的反馈，避免将环境噪声误判为策略带来的收益波动。 |
| **设计初衷** | **模拟人类行为**<br>模拟现实中人的有限理性和日常习惯的随机性 | **数值求解优化**<br>为了在数学上逼近严格的纳什均衡点 | **提升训练效率**<br>更准确的均衡状态意味着更准确的收益计算，加速 MADDPG 收敛。 |

**实施计划**：
1.  **MSA (Method of Successive Averages)**: 让切换概率随迭代次数 $n$ 衰减（例如 $\frac{20}{20+n}$）。
2.  **Gap Scaling**: 让切换概率与相对成本差（Relative Gap）成正比。

**MSA 在基于路径方法上的应用**：

```python
# 当前方法（随机切换）- 问题：振荡
for veh in vehicles:
    if random() < 0.05 and 存在更优路径:
        veh.route = better_route  # 离散、随机、振荡

# MSA方法 - 解决方案：流量比例加权平均
α = 1 / iteration  # 步长递减

for od in all_od_pairs:
    costs = {r: get_cost(r) for r in path_set[od]}
    best_route = min(costs, key=costs.get)

    # MSA更新：流量比例向最优路径移动
    for r in path_set[od]:
        if r == best_route:
            proportion[od][r] = (1-α) * proportion[od][r] + α * 1.0
        else:
            proportion[od][r] = (1-α) * proportion[od][r] + α * 0.0
```

**预期效果**：
- 消除振荡，指标单调下降
- BF/Anaheim 的 P95 有望稳定在更低水平
- 为 RL 智能体提供确定性的 Reward 信号

**待完成**：
- [x] ~~实现 MSA 路径流量更新逻辑~~ (已废弃，见 5.2.10 节分析)
- [ ] 实现切换概率改进方案
- [ ] 在三个网络上验证改进效果
- [ ] 对比改进前后的收敛速度和稳定性

#### 5.2.10 MSA 方案可行性分析与替代方案 ✅ 已完成 (2025-12)

**背景**：5.2.9 节提出的 MSA 方案需要重新评估其在 UXSim 介观仿真模型中的适用性。

##### 5.2.10.1 UXSim 需求加载机制分析

UXSim 使用 `adddemand` 加载交通需求，其核心逻辑为：

```
输入: orig, dest, t_start, t_end, flow (veh/s)
参数: DELTAN=5 (platoon大小), DELTAT=5s (时间步长)

for t in [t_start, t_end] 每个时间步:
    累积流量 f += flow × DELTAT
    while f >= DELTAN:
        创建一个 Vehicle (代表 DELTAN 辆实际车辆)
        f -= DELTAN
```

**关键特征**：
- 同一 OD 对的 Vehicle 在**不同时间点**分散发车
- 每个 Vehicle 有独立的 `departure_time`
- 低流量时：可能数百秒才创建一个 Vehicle
- 高流量时：每个时间步可能创建多个 Vehicle

##### 5.2.10.2 OD 级别 MSA 的不适用性分析

**传统 MSA 假设**：
- 操作对象：OD 对级别的**连续流量比例** `proportion[OD][route] ∈ [0,1]`
- 时间处理：忽略发车时间差异，所有车辆使用相同的路径比例

**UXSim DTA 现实**：
- 操作对象：**离散的 Vehicle 个体**
- 时间处理：每个 Vehicle 根据自己的发车时间面对不同路况

**核心矛盾**：

| 发车时间 | 路况 | 最优路径 |
|---------|------|---------|
| t=0s (早高峰初期) | 路网空闲 | 路径A (短但容量小) |
| t=1800s (高峰中期) | 路网拥堵 | 路径B (长但容量大) |
| t=3000s (高峰末期) | 部分恢复 | 路径A |

如果使用 OD 级别统一比例 `[A:60%, B:40%]`：
- t=0s 的车走 A：✓ 正确
- t=1800s 的车走 A：✗ 错误（此时应走 B）

**结论**：OD 级别的流量比例分配会**破坏 DTA 的时变特性**，不适用于当前场景。

##### 5.2.10.3 当前实现的合理性确认

当前 `__route_choice_update` 的实现是**正确的 DTA 处理方式**：

1. **逐 Vehicle 决策**：每辆车独立评估最优路径
2. **考虑发车时间**：`__estimate_route_cost(route, veh.departure_time, ...)` 使用车辆自身的发车时间
3. **时变路况**：`link.actual_travel_time(current_time)` 获取时变的链路旅行时间

**问题不在于"逐 Vehicle 决策"本身，而在于"固定概率随机切换"导致的振荡**。

##### 5.2.10.4 替代方案：切换概率改进

保持逐 Vehicle 决策框架，改进切换概率计算方式：

**当前机制**：
$$P_{switch} = \begin{cases} 0.05 & \text{if } gap > 0 \\ 0 & \text{otherwise} \end{cases}$$

**问题**：概率恒定，系统永远振荡。

---

**方案 A：衰减切换概率**

$$P_{switch}(n) = \frac{P_0}{1 + \alpha \cdot n}$$

- $P_0 = 0.05$（初始切换概率）
- $\alpha$：衰减速率，建议范围 0.02~0.1
- $n$：当前迭代轮数

| 迭代轮数 | α=0.05 | α=0.1 |
|---------|--------|-------|
| 1 | 4.8% | 4.5% |
| 10 | 3.3% | 2.5% |
| 50 | 1.4% | 0.8% |
| 100 | 0.8% | 0.5% |

**特点**：简单，强制收敛，但可能过早冻结次优解。

---

**方案 B：Gap 敏感切换**

$$P_{switch} = \min(1, \gamma \cdot gap_{rel})$$

- $gap_{rel} = \frac{cost_{current} - cost_{best}}{cost_{current}}$（相对成本差）
- $\gamma$：敏感度系数，建议范围 5~20

| 相对成本差 | γ=10 | γ=20 |
|-----------|------|------|
| 10% | 100% | 100% |
| 5% | 50% | 100% |
| 1% | 10% | 20% |
| 0.1% | 1% | 2% |

**特点**：差距大时积极切换，差距小时几乎不动，自适应性强。

---

**方案 C：组合方案（推荐）**

$$P_{switch}(n) = \min(1, \gamma \cdot gap_{rel}) \cdot \frac{1}{1 + \alpha \cdot n}$$

**两层控制**：
1. **Gap 敏感**（$\gamma \cdot gap_{rel}$）：决定"该不该换"——差距小则不换
2. **时间衰减**（$\frac{1}{1+\alpha n}$）：决定"换多少"——后期整体降温

**效果示例**（$\gamma=10, \alpha=0.05$）：

| 迭代 | gap=10% | gap=1% | gap=0.1% |
|-----|---------|--------|----------|
| 1 | 95% | 9.5% | 0.95% |
| 20 | 50% | 5.0% | 0.50% |
| 100 | 17% | 1.7% | 0.17% |

**预期行为**：
- 迭代初期：大量车辆找到更好路径，高概率切换 → 快速探索
- 迭代中期：多数车辆已在较优路径，gap 变小 → 切换减少
- 迭代后期：gap 很小 + 概率衰减 → 几乎冻结 → GM 稳定

##### 5.2.10.5 参数选择建议

| 参数 | 含义 | 建议值 | 调优方向 |
|-----|------|-------|---------|
| $\gamma$ | Gap 敏感度 | 10 | 越大 → 小差距越敏感 |
| $\alpha$ | 衰减速率 | 0.05 | 越大 → 收敛越快但可能次优 |

**收敛判断调整**：

原收敛条件仅基于 GM 阈值。改进后可增加**稳定性条件**：

$$\text{converged} = (GM < \theta) \land (\sigma_{GM,last10} < \epsilon)$$

即：GM 低于阈值，**且**最近 10 轮 GM 的标准差足够小（不再振荡）。

##### 5.2.10.6 待实施任务

- [ ] 在 `__route_choice_update` 中实现方案 C（组合方案）
- [ ] 添加迭代轮数参数传递机制
- [ ] 在三个网络上验证改进效果
- [ ] 对比改进前后的 GM 收敛曲线和稳定性
- [ ] 确定最终的 $\gamma$ 和 $\alpha$ 参数值

### 5.3 Anaheim 数据集 ✅ 已完成

**定位**: **规模泛化验证**。作为 Sioux Falls (理论) 到 Berlin (真实) 之间的"中型进阶算例"。

**特征**:
*   **来源**: `bstabler/TransportationNetworks` (TNTP格式)
*   **规模**: 416 节点 / 914 链路 / 38 交通小区 (Zones)。
*   **优势**:
    *   结构比 SF 更真实，包含清晰的主干道层级。
    *   需求基于区域对 (Zone-to-Zone)，比 BF 的点对点 (Point-to-Point) 需求分布更均匀，天然具备良好的连通性，无需过度依赖需求倍增。

**已完成**:
- [x] TNTP 格式清洗与转换 (坐标归一化、容量/需求单位换算)
- [x] 在 UE-DTA 收敛实验中验证 (100轮 + 300轮)
- [x] 确定收敛标准：GM<5% + P95<20%，约38轮收敛

**测试结果汇总**:

| 指标 | 初始值 | 100轮 | 300轮 |
|-----|-------|-------|-------|
| Global Mean | 10.84% | 3.12% | 3.09% |
| P95 | 65.08% | 18.87% | 18.69% |
| OD Max | 96.38% | 72.65% | 78.12% |

---

## 6. 三数据集对比总结

| 数据集 | 节点数 | 链路数 | OD对数 | 充电站数 | UE收敛特性 | 推荐收敛标准 |
|-------|-------|-------|-------|---------|-----------|-------------|
| **Sioux Falls** | 24 | 76 | 528 | 6 | 良好 | GM<2% + P95<10% |
| **Berlin** | 191 | 451 | 506 | 20 | 困难（管状） | GM<5% + P95<30% |
| **Anaheim** | 416 | 914 | 1406 | 20 | 中等 | GM<5% + P95<20% |
